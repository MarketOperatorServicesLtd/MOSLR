# Market Performance Standards

## Performance Charges

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, fig.width = 12, fig.height = 5}

mps_data_clean_temp %>%
  dplyr::filter(
    Date <= data.period
    ) %>%
  dplyr::select(
    Trading.Party.ID, Date, Standard, Charges, Group
    ) %>%
  ggplot2::ggplot(
    ggplot2::aes(x = Date, y = Charges, fill = Group)
    ) + 
  ggplot2::geom_bar(stat = "identity") + 
  ggplot2::theme(
    legend.title = ggplot2::element_blank(),
    text = ggplot2::element_text(size = 15)
    ) +
  ggplot2::scale_y_continuous(
    labels = scales::dollar_format(prefix = "£"),
    breaks = scales::pretty_breaks(4)
    ) +
  ggplot2::theme_bw() +
  ggplot2::scale_fill_manual(values = c("#425563", "#05C3DE", "#005F83", "#00A499", "#FFAA4D", "#F9E547", "#8866BC")) +
  ggplot2::labs(
    title = "Performance Charges",
    subtitle = "Breakdown by month and standard grouping",
    caption = "Source: MOSL"
    ) +
  ggplot2::ylab("") + ggplot2::xlab("")

```

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE}

# Creating table of charges by MPS ---------------- 

mps_data_clean_temp %>%
  dplyr::filter(
    Date >= data.period %m-% months(11)
    ) %>%
  dplyr::select(Date, Standard, Charges) %>%
  dplyr::mutate(
    Date = format(Date, "%Y-%m")
    ) %>% 
  tidyr::spread(Standard, Charges) %>%
  dplyr::mutate(
    Total = rowSums(dplyr::select(., -Date), na.rm = TRUE)
    ) %>%
  dplyr::mutate_if(~ any(is.na(.)), ~ ifelse(is.na(.), 0, .)) %>%
  dplyr::mutate_if(is.numeric, scales::dollar_format(prefix = "£")) %>%
  kableExtra::kable(
    format = "latex", 
    caption = "Breakdown of Charges by Standard", 
    linesep = "",
    format.args = list(big.mark = ","),
    booktabs = TRUE,
    align = "c"
    ) %>%
  kableExtra::kable_styling(
    font_size = 10,
    latex_options = c(
      "repeat_header",
      "hold_position",
      "striped",
      position = "center", 
      full_width = FALSE,
      "scale_down"
      )
    ) %>%
  kableExtra::row_spec(0, bold = TRUE)

```

## Performance Overview

As of `r format(data.period, "%B-%Y")`, MOSL were monitoring `r SHORT.NAME`'s performance against `r nrow(perf_status_mps_temp)` standards. The performance of Trading Parties against these standards is measured according to:

* `r paste(unique(perf_status_mps_temp$PerformanceMeasure), collapse = "and")`

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, fig.width = 12, fig.height = 5}

agg_perf <- mps_aggregate_perf %>%
  dplyr::filter(Trading.Party.ID == TRADING.PARTY) %>%
  dplyr::select(Date, Agg_Perf) %>%
  dplyr::rename(GroupPerf = Agg_Perf) %>%
  dplyr::mutate(Group = "Aggregate Performance")

mps_data_clean_temp %>%
  dplyr::group_by(Date, Group) %>%
  dplyr::summarise(
    GroupPerf = sum(OnTimeTasks) / sum(TaskVolume)
    ) %>%
  dplyr::ungroup() %>%
  base::rbind(., agg_perf) %>%
  droplevels() %>%
  ggplot2::ggplot() + 
  ggplot2::geom_line(
    ggplot2::aes(
      x = Date, 
      y = GroupPerf, 
      colour = Group,
      linetype = Group
      )
    ) +
  ggplot2::geom_point(
    ggplot2::aes(
      x = Date, 
      y = GroupPerf,
      colour = Group,
      fill = Group,
      shape = Group
      )
    ) +
  ggplot2::theme(
    legend.title = ggplot2::element_blank(),
    text = ggplot2::element_text(size = 15)
    ) +
  ggplot2::scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    breaks = scales::pretty_breaks(4)
    ) +
  ggplot2::theme_bw() + 
  ggplot2::scale_colour_manual(
    values = c("#425563", "#05C3DE", "#005F83", "#00A499", "#FFAA4D", "#F9E547", "#8866BC")
    ) +
  ggplot2::scale_fill_manual(
    values = c("#425563", "#05C3DE", "#005F83", "#00A499", "#FFAA4D", "#F9E547", "#8866BC")
    ) +
  ggplot2::labs(
    title = paste0("MPS On-Time Task Completion: ", SHORT.NAME),
    subtitle = "Breakdown by month and standard",
    caption = "Source: MOSL\nNote: Aggregate performance corresponds to the 6-month average of aggregate MPS performance"
    ) +
  ggplot2::ylab("") + ggplot2::xlab("")

```


```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, results = "asis"}

mps_data_clean_temp %>% 
  dplyr::filter(
    Date >= max(mps_data_clean_temp$Date) %m-% months(11)
    ) %>%
  dplyr::mutate(
    Performance = scales::percent(Performance, accuracy = 1),
    Date = format(Date, "%Y-%m")
    ) %>%
  dplyr::select(
    Date, Standard, Performance
    ) %>%
  tidyr::spread(key = Standard, value = Performance) %>%
  kableExtra::kable(
    format = "latex", 
    caption = "MPS Performance by Month",
    linesep = "",
    format.args = list(big.mark = ","),
    booktabs = TRUE,
    align = "c"
    ) %>%
  kableExtra::kable_styling(
    font_size = 10,
    latex_options = c(
      "repeat_header",
      "hold_position",
      "striped",
      position = "center", 
      full_width = FALSE,
      "scale_down"
      )
    ) %>%
  kableExtra::row_spec(0, bold = TRUE)

```

`r SHORT.NAME`'s 6-month average aggregate MPS performance is `r scales::percent(mps_aggregate_perf_temp$Agg_Perf_roll, accuracy = 1)`, which currently ranks as:

* `r scales::ordinal(mps_aggregate_perf_temp$rank_all)` out of `r mps_aggregate_perf_temp$n_all` for all Trading Parties
* `r scales::ordinal(mps_aggregate_perf_temp$rank_type)` out of `r paste0(mps_aggregate_perf_temp$n_type, " ", mps_aggregate_perf_temp$tp_type)`s
* `r scales::ordinal(mps_aggregate_perf_temp$rank_subtype)` out of `r mps_aggregate_perf_temp$n_subtype` trading parties with licence type `r mps_aggregate_perf_temp$sub_type`

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, fig.width = 12, fig.height = 6}

mps_aggregate_perf %>%
  dplyr::filter(
    sub_type == as.character(mps_aggregate_perf_temp$sub_type),
    Date == data.period
    ) %>%
  ggplot2::ggplot() +
  ggplot2::geom_bar(
    ggplot2::aes(
      x = reorder(ShortName, Agg_Perf_roll), 
      y = Agg_Perf_roll,
      fill = dplyr::if_else(Trading.Party.ID == TRADING.PARTY, "highlight", "normal")
      ), 
    stat = "identity",
    show.legend = FALSE) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  ggplot2::scale_fill_manual(values = c("#425563", "azure3")) +
  ggplot2::coord_flip() +
  ggplot2::theme_bw() +
  ggplot2::theme(
    text = ggplot2::element_text(size = 15)
    ) +
  ggplot2::labs(
    title = "Ranking of Overall MPS Performance",
    subtitle = 
      paste0(
        "Rolling 6-month mean of aggregate MPS performance by Trading Party (", 
        mps_aggregate_perf_temp$sub_type, ")"
        ),
    caption = "Source: MOSL"
    ) +
  ggplot2::ylab("") + ggplot2::xlab("")

```

The current status of `r SHORT.NAME`'s performance against each standard and performance measure is summarised in the table(s) below: 

``` {r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, results = "asis"}

perf_status_mps_temp %>%
  dplyr::select(
    Standard, SecondaryCategory, Consistency, PerfRating, Status, Action
    ) %>%
  dplyr::mutate(
    Status = tidyr::replace_na(Status, "")
    ) %>%
  kableExtra::kable(
    format = "latex", 
    caption = "Current Status of MPS",
    linesep = "",
    booktabs = TRUE,
    col.names = c("MPS", "Category", "Performance Consistency", "Performance Rating", "IPRP Status", "MOSL Action"),
    align = c("llcccc")
    ) %>%
  kableExtra::column_spec(3:4, width = "3.5cm") %>%
  kableExtra::kable_styling(
    latex_options = c(
      "repeat_header",
      "HOLD_position",
      "striped",
      position = "center", 
      full_width = FALSE,
      "scale_down"
      )
    ) %>%
  kableExtra::row_spec(0, bold = TRUE)

```

<br>

See Appendix for an explanation of how MOSL rates Trading Party performance and consistency against the standards.

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, fig.width = 12, fig.height = 6}

perf_status_mps_temp %>%
  ggplot2::ggplot() +
  ggrepel::geom_label_repel(
    ggplot2::aes(
      x = rolling.sd,
      y = rolling.mean,
      label = Standard,
      fill = Group
      ), 
    alpha = 0.8,
    colour = "white"
    ) +
  ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  ggplot2::scale_x_reverse(labels = scales::percent_format(accuracy = 1)) +
  ggplot2::theme_bw() +
  ggplot2::scale_fill_manual(
    values = c("#425563", "#05C3DE", "#005F83", "#00A499", "#FFAA4D", "#F9E547", "#8866BC")
    ) +
  ggplot2::theme(
    text = ggplot2::element_text(size = 15)
    ) +
  ggplot2::labs(
    title = paste0("MPS Performance and Consistency as of ", format(as.Date(data.period), '%B %Y')),
    subtitle = "Rolling 6-month mean and standard deviation of MPS performance",
    caption = "Source: MOSL"
    ) +
  ggplot2::ylab("Performance") + ggplot2::xlab("Consistency")

```

## Detailed Analysis

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, results = "asis"}

mps_list <- unique(as.character(perf_status_mps_temp$Standard))

res <- lapply(mps_list, function (MPS_CHUNK) {
  
  knitr::knit_child(
    "pfm_report_mps_template.Rmd", envir = environment(), quiet = TRUE
    )
  }
  )

cat(unlist(res), sep = "\n")

```

## Market Aggregates

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, results = "asis"}

metrics.list <- c("MarketMean", "MarketMedian", "MarketTaskVolume")

for (METRIC in metrics.list) {

  mps_summary %>% 
    dplyr::select(
      Date, Standard, METRIC
      ) %>% 
    dplyr::filter(
      Date >= data.period %m-% months(11)
      ) %>% 
    dplyr::mutate(Date = format(Date, "%Y-%m")) %>%
    tidyr::spread(Date, METRIC) %>%
    dplyr::mutate_if(
      is.numeric, 
      ifelse(
        METRIC != "MarketTaskVolume", 
        scales::percent_format(accuracy = 1), 
        scales::number_format(big.mark = ",", accuracy = 1)
        )
      ) %>%
    kableExtra::kable(
      format = "latex", 
      caption = paste0("Market ", base::gsub("_", x = METRIC, replacement = " ")), 
      linesep = "",
      digits = 1,
      booktabs = TRUE,
      align = "c"
      ) %>%
    kableExtra::kable_styling(
      latex_options = c(
        "repeat_header",
        "HOLD_position",
        "striped",
        "scale_down"
        )
      ) %>%
    kableExtra::row_spec(0, bold = TRUE) %>%
    print()
  
  cat("\n")
    
}

```
