---
title: 'Portfolio Manager Report: `r paste0(TRADING.PARTY.NAME, " (",TRADING.PARTY,")")`'
date: "`r format(as.Date(data.period), '%B %Y')`"
fontsize: 12pt
output:
  pdf_document:
    fig_height: 3.2
    fig_width: 8
    number_section: yes
    toc: yes
    fig_caption: true
header-includes:
- \usepackage{titling}
- \pretitle{\begin{center}\LARGE\includegraphics[width=24cm]{mosl_title.png}\\[\bigskipamount]}
- \posttitle{\end{center}}
- \usepackage{xcolor}
- \usepackage{color}
- \usepackage{fancyhdr}
- \usepackage{graphicx}
- \usepackage{eurosym}
- \usepackage{longtable}
- \usepackage{booktabs}
- \usepackage{makecell}
- \usepackage{pdflscape}
- \usepackage{multirow}
- \usepackage{float}
- \pagestyle{fancy}
- \fancyhf{}
- \lfoot{MOSL Performance Report}
- \rhead{\includegraphics[width=6cm]{mosl_header.png}}
- \rfoot{Page \thepage}
classoption: table
---

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, child = "pfm_report_mps_section.Rmd", eval = nrow(mps_data_clean_temp) > 0}

```

\newpage

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, child = "pfm_report_ops_section.Rmd", eval = nrow(ops_data_clean_temp) > 0}

```

\newpage

# Appendix

## Full MPS Performance ranking

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, fig.width = 12, fig.height = 8}

tryCatch(
  expr = {
  mps_aggregate_perf %>%
    dplyr::filter(
      tp_type == as.character(mps_aggregate_perf_temp$tp_type),
      Period == data.period
      ) %>%
    ggplot2::ggplot() +
    ggplot2::geom_bar(
      ggplot2::aes(
        x = reorder(ShortName, Agg_Perf_roll), 
        y = Agg_Perf_roll,
        fill = dplyr::if_else(Trading.Party.ID == TRADING.PARTY, "highlight", "normal")
        ), 
      stat = "identity",
      show.legend = FALSE) +
    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    ggplot2::scale_fill_manual(values = c("#425563", "azure3")) +
    ggplot2::coord_flip() +
    ggplot2::theme_bw() +
    ggplot2::theme(
      text = ggplot2::element_text(size = 15)
      ) +
    ggplot2::labs(
      title = "Ranking of Overall MPS Performance",
      subtitle = 
        paste0(
          "Rolling 6-month mean of aggregate MPS performance by Trading Party (", 
          mps_aggregate_perf_temp$tp_type, "s)"
          ),
      caption = "Source: MOSL"
      ) +
    ggplot2::ylab("") + ggplot2::xlab("")
  }, error = function(e){}
)

```

`r if(nrow(ops_data_clean_temp)>0){paste("## Full OPS Performance ranking")}`

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, fig.width = 12, fig.height = 8, eval = nrow(ops_data_clean_temp) > 0}

tryCatch(
  expr = {
  ops_aggregate_perf %>%
    dplyr::filter(
      Period == data.period,
      PerformanceMeasure == "Completed"
      ) %>%
    ggplot2::ggplot() +
    ggplot2::geom_bar(
      ggplot2::aes(
        x = reorder(ShortName, Agg_Perf_roll), 
        y = Agg_Perf_roll,
        fill = dplyr::if_else(Trading.Party.ID == TRADING.PARTY, "highlight", "normal")
        ), 
      stat = "identity",
      show.legend = FALSE) +
    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    ggplot2::scale_fill_manual(values = c("#425563", "azure3")) +
    ggplot2::coord_flip() +
    ggplot2::theme_bw() + 
    ggplot2::theme(
      text = ggplot2::element_text(size = 15)
      ) +
    ggplot2::labs(
      title = "Ranking of Overall OPS Performance (Completed)",
      subtitle = 
        paste0(
          "Rolling 6-month mean of aggregate OPS performance by Trading Party"),
      caption = "Source: MOSL"
      ) +
    ggplot2::ylab("") + ggplot2::xlab("")
  }, error = function(e){}
)

```

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE, fig.width = 12, fig.height = 8, eval = nrow(ops_data_clean_temp) > 0}

tryCatch(
  expr = {
  ops_aggregate_perf %>%
    dplyr::filter(
      Period == data.period,
      PerformanceMeasure == "Outstanding"
      ) %>%
    ggplot2::ggplot() +
    ggplot2::geom_bar(
      ggplot2::aes(
        x = reorder(ShortName, Agg_Perf_roll), 
        y = Agg_Perf_roll,
        fill = dplyr::if_else(Trading.Party.ID == TRADING.PARTY, "highlight", "normal")
        ), 
      stat = "identity",
      show.legend = FALSE) +
    ggplot2::scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
    ggplot2::scale_fill_manual(values = c("#425563", "azure3")) +
    ggplot2::coord_flip() +
    ggplot2::theme_bw() + 
    ggplot2::theme(
      text = ggplot2::element_text(size = 15)
      ) +
    ggplot2::labs(
      title = "Ranking of Overall OPS Performance (Outstanding)",
      subtitle = 
        paste0(
          "Rolling 6-month mean of aggregate OPS performance by Trading Party"),
      caption = "Source: MOSL"
      ) +
    ggplot2::ylab("") + ggplot2::xlab("")
  }, error = function(e){}
)

```

## Grouping details

### MPS

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE}
MPS_grouping <- dplyr::tibble("Customer Access"=c("MPS 1", "MPS 2", "MPS 3", "MPS 4", "MPS 5",""), 
                       "Disconnection/ Reconnection" = c("MPS 6", rep("", 5)),
                       "Meter Read Submission" = c("MPS 7", "MPS 8", "MPS 9", "MPS 10", "MPS 11", ""),
                       "Cyclic Meter Reads" = c("MPS 12", "MPS 13", "MPS 14", "MPS 15", "MPS 18", "MPS 19"),
                       "Transfer Reads" = c("MPS 16", "MPS 17", rep("", 4)))

MPS_grouping%>% 
  kableExtra::kable(
    format = "latex", 
    caption = "Details of MPS Groupings",
    linesep = "",
    format.args = list(big.mark = ","),
    booktabs = TRUE,
    align = "c"
    ) %>%
  kableExtra::kable_styling(
    font_size = 10,
    latex_options = c(
      "repeat_header",
      "HOLD_position",
      "striped",
      position = "center", 
      full_width = FALSE
      )
    ) %>%
  kableExtra::row_spec(0, bold = TRUE)%>%
  kableExtra::column_spec(1:ncol(MPS_grouping), width = "2.4cm")
```

### OPS

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE}
OPS_grouping <- dplyr::tibble("Metering" = c("OPS B1a", "OPS B3a", "OPS B3b", "OPS B5a", rep("", 4)),
                       "Supply Check" = c("OPS C1a", "OPS C1b", "OPS C2a", "OPS C3a", "OPS C4a", "OPS C4b", "OPS C5a", "OPS C6a"),
                       Complaints = c("OPS F5a", "OPS F5b", rep("", 6)),
                       "Trade Effluent" = c("OPS G2a", "OPS G4a", "OPS G4b", rep("", 5)),
                       Allowances = c("OPS H1a", rep("", 7)),
                       "Disconnection/ Reconnection" = c("OPS I1a", "OPS I1b", "OPS I8a", "OPS I8b", rep("", 4)))

OPS_grouping%>% 
  kableExtra::kable(
    format = "latex", 
    caption = "Details of OPS groupings",
    linesep = "",
    format.args = list(big.mark = ","),
    booktabs = TRUE,
    align = "c"
    ) %>%
  kableExtra::kable_styling(
    font_size = 10,
    latex_options = c(
      "repeat_header",
      "HOLD_position",
      "striped",
      position = "center", 
      full_width = FALSE
      )
    ) %>%
  kableExtra::row_spec(0, bold = TRUE)%>%
  kableExtra::column_spec(1:ncol(OPS_grouping), width = "2.4cm")
```

## Performance Criteria

### Market Performance Standards

A Trading Party's performance will be flagged when the ratio of on-time task completion to total tasks completed for that MPS falls below the peer mean and peer median level for three consecutive months. "Peer mean" and "peer median" refer, respectively, to the mean and median of all on-time task ratios for every Trading Party in the market. 

The following MPS are currently subject to this criterion: MPS 1, MPS 2, MPS 3, MPS 4, MPS 7, MPS 12, MPS 16, MPS 17.

MPS performance will also be flagged when it is lower than the threshold percentage, set by MOSL. Note that this threshold can change. 

Currently, only MPS 18 is subject to a threshold, of 75%.

When evaluating these performance flags, MOSL takes into account other factors, including: performance relative to comparable peers; number of tasks relative to size; and other important Trading Party activities, such as data improvement activity and significant operational changes.

Persistently poor performance could lead to the issue being escalated to MOSL's Performance Resolution process through an Initial Performance Rectification Plan (IPRP). Failure to improve over time at this stage could lead to the issue being further escalated to a Performance Rectification Plan (PRP) overseen by MPC and / or Panel.

### Operational Performance Standards

A Trading Party’s performance will be flagged when the KPI (ratio of on-time task completion to total tasks completed) for that OPS falls below the set threshold for three consecutive months. Similarly, performance will also be flagged when the API (ratio of tasks outstanding in time to total tasks outstanding) for that OPS falls below the set threshold for three consecutive months. Currently, the thresholds are 85% for the KPI and 75% for the API.

The following OPS are currently subject to these criteria: OPS B5a, OPS C1a.

When evaluating these performance flags, MOSL takes into account other factors, including: performance relative to comparable peers; number of tasks relative to size; and other important Trading Party activities, such as data improvement activity and significant operational changes.

Persistently poor performance could lead to the issue being escalated to MOSL’s Performance Resolution process through an Initial Performance Rectification Plan (IPRP). Failure to improve over time at this stage could lead to the issue being further escalated to a Performance Rectification Plan (PRP) overseen by MPC and / or Panel.

## Rating and Categorisation of Performance

As part of its analysis of historical performance, MOSL categorises performance over a 6-month period according to **consistency** and by **rating** absolute performance. Consistency is based on a 6-month rolling standard deviation of performance (whether in relation to a particular standard or aggregated across a group or all standards), with the following classification:

* Less than 1% is "Very Consistent
* Between 1-2% is "Consistent"
* Between 2-5% is "Inconsistent"
* Greater than 5% is "Very Inconsistent"

The performance rating is based on a 6-month rolling mean of performance (whether in relation to a particular standard or aggregated across a group or all standards) and is classified on an absolute scale as follows:

* Greater than 90% is "Very Good"
* Between 80-90% is "Good"
* Between 70-80% is "Poor"
* Less than 70% is "Very Poor"

## Categorisation and MOSL Actions

The categorisation of a performance standard or Additional Performance Indicator (API) each period is determined by the following:

* Whether Performance Rectification is underway (i.e. an IPRP or PRP has been initiated)
* Performance in the previous period
* MOSL actions in the previous period

A new period begins once the performance data has been processed for the previous period. For example MPS data is processed on the 6th business day of each month and therefore the 6th business day marks the beginning of the period for MPS. Other standards will have different starting points. 

```{r pressure, echo = FALSE, fig.cap = "Diagram of possible states and corresponding MOSL actions", out.width = '100%'}

knitr::include_graphics("standardstates.jpg")

```
