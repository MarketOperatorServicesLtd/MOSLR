## A. High Quality Consumption & Asset Data

### Vacancy - Market Level Reporting 

```{r, fig.height = 5}

history_vac <- vacant %>%
  dplyr::group_by(Period) %>%
  dplyr::summarise(
    VacantPremises = sum(VacantPremises),
    total = sum(Premises),
    percent_vacant = sum(VacantPremises) / sum(Premises)
    ) %>%
  dplyr::filter(Period > "2019-03-01")

history_vac %>%
  ggplot2::ggplot() +
  ggplot2::geom_col(ggplot2::aes(x = Period, y = VacantPremises), show.legend = FALSE) +
  MOSLR::scale_fill_MOSL() +
  ggplot2::labs(title = "Vacant premises", y = "Total number of vacant premises", x = "") +
  ggplot2::theme_bw()
    
```

> This chart shows the change in volume (bars) and % (line) of vacant premises, with a forecast for the next 3 months

\newpage
\blandscape

### Vacancy - Trading Party Level Reporting 

```{r, fig.height = 4.8, fig.width = 10}

vac_MO_avg <- vacant %>%
      dplyr::filter(Period == "2017-04-01") %>%
      dplyr::summarise(Total = sum(VacantPremises) / sum(Premises))

graph_data <- MOSLR::MPOP_data_prep(
  df.vacancy = vacant, 
  tp.details = tp_details, 
  vacancy.table = TRUE, 
  by = "Retailer", 
  my.dir = my_dir
  )

# MOSLR::bubble_chart(
#   df = graph_data, 
#   vacancy.graph = TRUE,
#   by = "Retailer", 
#   vertical.sep = vac_MO_avg$Total
#   ) 

vertical.sep <- 0.15
arrow = ggplot2::arrow(angle = 10, type = "closed")

graph_data %>%
  ggplot2::ggplot(ggplot2::aes(x = percent, y = change, label = ShortName)) +
  ggplot2::geom_rect(xmin = -Inf, xmax = -vertical.sep - 0.025, ymin = -Inf, ymax = 0, fill = "#F08080", alpha = 0.1) +
  ggplot2::geom_rect(xmin = -Inf, xmax = -vertical.sep - 0.025, ymin = 0, ymax = Inf, fill = "#FFE699", alpha = 0.1) +
  ggplot2::geom_rect(xmin = -vertical.sep - 0.025, xmax = Inf, ymin = -Inf, ymax = 0, fill = "#FFE699", alpha = 0.1) +
  ggplot2::geom_rect(xmin = -vertical.sep - 0.025, xmax = Inf, ymin = 0, ymax = Inf, fill = "#C6E0B4", alpha = 0.1) +
  ggplot2::geom_point(ggplot2::aes(size = TotalPremises, fill = `Change in size`), pch = 21) +
  ggrepel::geom_text_repel(size = 2.5, fontface = "bold") +
  ggplot2::annotate(geom = "label", x = -0.025, y = -max(abs(graph_data$change)), label = "Leading", fill = "azure2") +
  ggplot2::annotate(geom = "label", x = 2 * (vertical.sep + 0.025) + 0.02, y = -max(abs(graph_data$change)), label = "Improving", fill = "azure2") +
  ggplot2::annotate(geom = "label", x = -0.03, y = max(abs(graph_data$change)), label = "At risk", fill = "azure2") +
  ggplot2::annotate(geom = "label", x = 2 * (vertical.sep + 0.025) + 0.023, y = max(abs(graph_data$change)), label = "Declining", fill = "azure2") +
  ggplot2::scale_x_reverse(labels = scales::percent_format(accuracy = 1), limits = c(2 * (vertical.sep + 0.025) + 0.03,-0.03)) +
  ggplot2::scale_y_reverse(labels = scales::percent_format(accuracy = 1), limits = c(max(abs(graph_data$change)), -max(abs(graph_data$change)))) +
  ggplot2::xlab("Total % of vacant premises") +
  ggplot2::ylab("Change in % of vacant premises in the last 12 months") +
  ggplot2::ggtitle("Vacant premises change in the last 12 months") +
  ggplot2::theme_classic() +
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 9, face = "bold"),
    axis.title = ggplot2::element_text(size = 9, face = "bold"),
    axis.line = ggplot2::element_line(arrow = arrow),
    title = ggplot2::element_text(size = 9, face = "bold"),
    plot.title = ggplot2::element_text(hjust = 0.5),
    legend.position = "bottom",
    legend.title = ggplot2::element_text(size = 12, face = "bold"),
    legend.text = ggplot2::element_text(size = 8)
    ) +
  ggplot2::scale_size_continuous(range = c(1, 20)) +
  ggplot2::scale_fill_manual(values = c("#005F83", "#05C3DE", "#CDCDCD")) +
  ggplot2::guides(size = FALSE, fill = ggplot2::guide_legend(override.aes = list(size = 7)))

```

> This chart shows relative volumes of Vacant Premises by Retailer and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however theirpercentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r}

top10_vac_ret <- graph_data %>%
  dplyr::arrange(dplyr::desc(percent)) %>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp, 
      format = "latex",
      background = dplyr::case_when(
         percent > vac_MO_avg$Total + 0.02 ~ "#F08080",
         percent > vac_MO_avg$Total - 0.02 & percent < vac_MO_avg$Total + 0.02 ~ "#FFE699",
         percent < vac_MO_avg$Total - 0.02 ~ "#C6E0B4",
         TRUE ~ "#FFFFFF"), 
      escape = FALSE
      ),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    VacantPremises = scales::comma(VacantPremises, digits = 0)
    ) %>%
   dplyr::select(Retailer, TotalPremises, VacantPremises, percent_temp)


knitr::kable(
  top10_vac_ret,
  booktabs = TRUE, "latex",
  col.names = c("Retailer", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "", escape = FALSE,
  caption = "Retailer Vacancy ranking",
  align = c("l", rep("r", ncol(top10_vac_ret) - 1))
    ) %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "striped", "scale_down")) %>%
  kableExtra::row_spec(1:nrow(top10_vac_ret), hline_after = TRUE)

```

\arrayrulecolor{white}

```{r}

knitr::kable(
  table_legend_vac, booktabs = TRUE, "latex", col.names = c("", " ", " "),
  linesep = "", escape = FALSE
    ) %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down")) %>%
  kableExtra::column_spec(1:3, width = "5cm")

```

\arrayrulecolor{black}

> Only Retailers with more than 200 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month

\newpage
\blandscape

```{r, fig.width = 10, fig.height = 5.2}

graph_data <- MOSLR::MPOP_data_prep(
  df.vacancy = vacant, 
  tp.details = tp_details, 
  vacancy.table = TRUE, 
  by = "Wholesaler", 
  my.dir = my_dir
  )

# MOSLR::bubble_chart(
#   df = graph_data, 
#   vacancy.graph = TRUE, 
#   by = "Wholesaler", 
#   vertical.sep = vac_MO_avg$Total
#   ) 

vertical.sep <- 0.15
arrow = ggplot2::arrow(angle = 10, type = "closed")

graph_data %>%
  ggplot2::ggplot(ggplot2::aes(x = percent, y = change, label = ShortName)) +
  ggplot2::geom_rect(xmin = -Inf, xmax = -vertical.sep - 0.025, ymin = -Inf, ymax = 0, fill = "#F08080", alpha = 0.1) +
  ggplot2::geom_rect(xmin = -Inf, xmax = -vertical.sep - 0.025, ymin = 0, ymax = Inf, fill = "#FFE699", alpha = 0.1) +
  ggplot2::geom_rect(xmin = -vertical.sep - 0.025, xmax = Inf, ymin = -Inf, ymax = 0, fill = "#FFE699", alpha = 0.1) +
  ggplot2::geom_rect(xmin = -vertical.sep - 0.025, xmax = Inf, ymin = 0, ymax = Inf, fill = "#C6E0B4", alpha = 0.1) +
  ggplot2::geom_point(ggplot2::aes(size = TotalPremises, fill = `Change in size`), pch = 21) +
  ggrepel::geom_text_repel(size = 2.5, fontface = "bold") +
  ggplot2::annotate(geom = "label", x = -0.025, y = -max(abs(graph_data$change)), label = "Leading", fill = "azure2") +
  ggplot2::annotate(geom = "label", x = 2 * (vertical.sep + 0.025) + 0.02, y = -max(abs(graph_data$change)), label = "Improving", fill = "azure2") +
  ggplot2::annotate(geom = "label", x = -0.03, y = max(abs(graph_data$change)), label = "At risk", fill = "azure2") +
  ggplot2::annotate(geom = "label", x = 2 * (vertical.sep + 0.025) + 0.023, y = max(abs(graph_data$change)), label = "Declining", fill = "azure2") +
  ggplot2::scale_x_reverse(labels = scales::percent_format(accuracy = 1), limits = c(2 * (vertical.sep + 0.025) + 0.03,-0.03)) +
  ggplot2::scale_y_reverse(labels = scales::percent_format(accuracy = 1), limits = c(max(abs(graph_data$change)), -max(abs(graph_data$change)))) +
  ggplot2::xlab("Total % of vacant premises") +
  ggplot2::ylab("Change in % of vacant premises in the last 12 months") +
  ggplot2::ggtitle("Wholesaler area Vacant premises change in the last 12 months") +
  ggplot2::theme_classic() +
  ggplot2::theme(
    axis.text = ggplot2::element_text(size = 9, face = "bold"),
    axis.title = ggplot2::element_text(size = 9, face = "bold"),
    axis.line = ggplot2::element_line(arrow = arrow),
    title = ggplot2::element_text(size = 9, face = "bold"),
    plot.title = ggplot2::element_text(hjust = 0.5),
    legend.position = "bottom",
    legend.title = ggplot2::element_text(size = 12, face = "bold"),
    legend.text = ggplot2::element_text(size = 8)
    ) +
  ggplot2::scale_size_continuous(range = c(1, 20)) +
  ggplot2::scale_fill_manual(values = c("#005F83", "#05C3DE", "#CDCDCD")) +
  ggplot2::guides(size = FALSE, fill = ggplot2::guide_legend(override.aes = list(size = 7)))


```


> This chart shows relative volumes of Vacant Premises by Wholesaler area and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however their percentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r}

top10_vac_whole <- graph_data %>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp,
      format = "latex",
      background = dplyr::case_when(
         percent > vac_MO_avg$Total + 0.02 ~ "#F08080",
         percent > vac_MO_avg$Total - 0.02 & percent < vac_MO_avg$Total + 0.02 ~ "#FFE699",
         percent < vac_MO_avg$Total - 0.02 ~ "#C6E0B4",
         TRUE ~ "#FFFFFF"
         ), 
      escape = FALSE),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    VacantPremises = scales::comma(VacantPremises, digits = 0)
    ) %>%
  dplyr::arrange(dplyr::desc(percent)) %>%
  dplyr::mutate(percent = paste0(round(percent * 100, 1), "\\%")) %>%
  dplyr::filter(!is.na(Total_Premises_april)) %>%
  dplyr::select(Wholesaler, TotalPremises, VacantPremises, percent_temp)

knitr::kable(top10_vac_whole,
  booktabs = TRUE, format = "latex",
  col.names = c("Wholesaler", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "", escape = FALSE, caption = "Wholesaler area Vacancy ranking", align = c("l", rep("r", ncol(top10_vac_whole) - 1))
  ) %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "striped", "scale_down")) %>%
  kableExtra::row_spec(1:nrow(top10_vac_whole), hline_after = TRUE)

```

\arrayrulecolor{white}

```{r}

knitr::kable(
  table_legend_vac, booktabs = TRUE, format = "latex", col.names = c("", " ", " "), linesep = "", escape = FALSE
  ) %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down")) %>%
  kableExtra::column_spec(1:3, width = "5cm")

```

\arrayrulecolor{black}

> Only Wholesalers with more than 200 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month

\newpage
\blandscape

```{r, fig.height = 5.2, fig.width = 10}

graph_data <- MOSLR::MPOP_data_prep(
  df.vacancy = vacant, 
  tp.details = tp_details, 
  vacancy.table = TRUE, 
  by = "Pair",
  my.dir = my_dir
  )

MOSLR::bubble_chart(
  df = graph_data, 
  vacancy.graph = TRUE, 
  by = "Pair", 
  vertical.sep = vac_MO_avg$Total
  ) 

```


> This chart shows relative volumes of Vacant Premises by Wholesaler-Retailer Pairing and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however theirpercentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r}

top10_vac_pair <- graph_data %>%
  dplyr::arrange(dplyr::desc(percent)) %>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp, format = "latex", 
      background = dplyr::case_when(
        percent > vac_MO_avg$Total + 0.02 ~ "#F08080",
        percent > vac_MO_avg$Total - 0.02 & percent < vac_MO_avg$Total + 0.02 ~ "#FFE699",
        percent < vac_MO_avg$Total - 0.02 ~ "#C6E0B4",
        TRUE ~ "#FFFFFF"
        ), 
      escape = FALSE),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    VacantPremises = scales::comma(VacantPremises, digits = 0)
    ) %>%
   dplyr::select(Pair, TotalPremises, VacantPremises, percent_temp)

knitr::kable(
  top10_vac_pair, booktabs = TRUE, format = "latex",
  col.names = c("Pairing", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "", escape = FALSE, caption = "Pairing Vacancy ranking", 
  align = c("l", rep("r", ncol(top10_vac_pair) - 1))
    ) %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "striped", "scale_down")) %>%
  kableExtra::row_spec(1:nrow(top10_vac_pair), hline_after = TRUE) %>%
  kableExtra::column_spec(1, width = "6.5cm")

```

\arrayrulecolor{white}

```{r}

knitr::kable(
  table_legend_vac, booktabs = TRUE, format = "latex", col.names = c("", " ", " "), linesep = "", escape = FALSE) %>%
  kableExtra::kable_styling(latex_options = c("hold_position", "scale_down")) %>%
  kableExtra::column_spec(1:3, width = "5cm")

```

\arrayrulecolor{black}

> Only Pairings with more than 6000 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month

\newpage
\blandscape


```{r}

vacant_current <- vacant %>%
  dplyr::filter(Period == max(vacant$Period)) %>%
  dplyr::mutate(percent = scales::percent(VacantPremises / Premises))

vac_TP_temp <- data.table::transpose(vacant_TP)

colnames(vac_TP_temp) <- vacant_TP$TradingPartyID

vacant_total <- tidyr::pivot_wider(
  dplyr::arrange(vacant_current, WholesalerID),
  id_cols = WholesalerID, 
  names_from = RetailerID, 
  values_from = VacantPremises
  ) %>%
  dplyr::bind_rows(
    dplyr::mutate_all(
      dplyr::select(vac_TP_temp[3, ], unique(vacant_current$RetailerID)), 
      as.numeric)
    ) %>%
  dplyr::left_join(
    dplyr::filter(vacant_TP, Period == max(vacant$Period)) %>% dplyr::select(TradingPartyID, Vacant_Premises), 
    by = c("WholesalerID" = "TradingPartyID")
    ) %>%
  dplyr::rename(Total = Vacant_Premises)

# vacant_total[nrow(vacant_total), 1] <- "Total"
# vacant_total[nrow(vacant_total), ncol(vacant_total)] <- vacant_Total$Total_Vacant_Premises

vacant_total <- vacant_total %>%
  dplyr::mutate_if(is.numeric, ~scales::comma(., accuracy = 1)) %>%
  dplyr::mutate_all(~replace(., is.na(.), ""))  

knitr::kable(
  vacant_total, "latex", booktabs = TRUE, linesep = "",
  caption = "Total number of vacant premises",
  align = c("l", rep("c", ncol(vacant_total) - 1)),
  col.names = c("", colnames(vacant_total)[2:ncol(vacant_total)])
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = "bordered",
    latex_options = c("hold_position", "scale_down", "striped"), 
    stripe_color = "blizzardblue"
  ) %>%
  kableExtra::column_spec(ncol(vacant_total) - 1, border_right = TRUE) %>%
  kableExtra::row_spec(0, angle = 90) %>%
  kableExtra::row_spec(nrow(vacant_total)-1, hline_after = TRUE) %>%
  kableExtra::row_spec(nrow(vacant_total), bold = TRUE) %>%
  kableExtra::column_spec(ncol(vacant_total), bold = TRUE)

```


```{r}

vacant_percent <- tidyr::pivot_wider(
    dplyr::arrange(vacant_current, WholesalerID),
    id_cols = WholesalerID,
    names_from = RetailerID, 
    values_from = percent
    ) %>%
  dplyr::bind_rows(
    dplyr::select(vac_TP_temp[4,], unique(vacant_current$RetailerID))
    ) %>%
  dplyr::left_join(
    dplyr::filter(vacant_TP, Period == max(vacant$Period)) %>% dplyr::select(TradingPartyID, percent), 
    by = c("WholesalerID" = "TradingPartyID")
    ) %>%
  dplyr::mutate_all(~replace(., is.na(.), "")) %>%
  dplyr::rename(Total = percent)

# vacant_percent[nrow(vacant_percent), 1] <- "Total"
# vacant_percent[nrow(vacant_percent), ncol(vacant_percent)] <- paste(round(100 * # vacant_Total$Market_Vacancy_Rate, 1), "%")

knitr::kable(
  vacant_percent, "latex", booktabs = TRUE, linesep = "",
  caption = "Percentage of vacant premises",
  align = c("l", rep("c", ncol(vacant_percent) - 1)),
  col.names = c("", colnames(vacant_percent)[2:ncol(vacant_percent)])
  ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down", "striped"), 
    stripe_color = "blizzardblue"
    ) %>%
  kableExtra::column_spec(ncol(vacant_percent)-1, border_right = TRUE) %>%
  kableExtra::row_spec(0, angle = 90)  %>%
  kableExtra::row_spec(nrow(vacant_percent) - 1, hline_after = TRUE) %>%
  kableExtra::row_spec(nrow(vacant_percent), bold = TRUE) %>%
  kableExtra::column_spec(ncol(vacant_percent), bold = TRUE)

```

\elandscape
\clearpage

