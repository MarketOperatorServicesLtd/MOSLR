

```{r setup, include=FALSE}
library(tidyverse)
library(ggrepel)
library(kableExtra)
library(knitr)
library(ggthemes)
library(lubridate)
library(openxlsx)
library(formattable)



wb<-createWorkbook("MPOP_tables")

addWorksheet(wb, "Longunread_numbers")
addWorksheet(wb, "Longunread_numbers_Since_MO")
addWorksheet(wb, "Longunread_percent")

addWorksheet(wb, "Vacant_numbers")
addWorksheet(wb, "Vacant_percent")

table_legend_long <- data.frame(Red = "Above market average", Yellow = "Below market average", Green = "Below target market level")%>%
  mutate(
    Red = cell_spec(
      Red,
      "latex", 
      background = "#F08080",
    ),
    Yellow = cell_spec(
      Yellow,
      "latex", 
      background = "#FFE699",
    ),
    Green = cell_spec(
      Green,
      "latex", 
      background = "#C6E0B4",
    ))

table_legend_vac <- data.frame(Red = "More than 2.5% over Market Opening average", Yellow = "Within $\\pm$ 2.5\\% of the Market Opening average", Green = "More than 2.5% less than Market Opening average")%>%
  mutate(
    Red = cell_spec(
      Red,
      "latex", 
      background = "#F08080",
    ),
    Yellow = cell_spec(
      Yellow, 
      "latex",
      background = "#FFE699",
      escape = FALSE
    ),
    Green = cell_spec(
      Green,
      "latex",
      background = "#C6E0B4",
    ))




    
```





## A. High Quality Consumption & Asset Data

### Vacancy - Market Level Reporting 

```{r, echo=FALSE,  warning=FALSE, error=FALSE, fig.height=5}
history_vac <- vacant%>%
  group_by(
    Period
    )%>%
  summarise(
    Vacancies = sum(Vacancies),
    total = sum(Premises),
    percent_vacant = sum(Vacancies)/sum(Premises)
    )%>%
  filter(
    Period > "2019-03-01"
    )

forecast_vac <- lm(percent_vacant~Period, data = history_vac[(nrow(history_vac)-4):nrow(history_vac),])

predict_vac <- data.frame(
  Period = c(
    max(history_vac$Period)%m+%months(1),
    max(history_vac$Period)%m+%months(2),
    max(history_vac$Period)%m+%months(3)
    )
  )

predict_vac$percent_vacant_forecast <- predict.lm(forecast_vac, predict_vac)

history_vac_forecast <- bind_rows(history_vac, predict_vac)

history_vac_forecast$percent_vacant_forecast[history_vac_forecast$Period==max(history_vac$Period)] <- history_vac_forecast$percent_vacant[history_vac_forecast$Period==max(history_vac$Period)]



ggplot(
  history_vac_forecast, 
  aes(
    x = Period
    )
  )+
  geom_bar(
    aes(
      x=Period,
      y = Vacancies
      ),
    stat = "identity",
    position = "dodge", 
    inherit.aes = FALSE,
    fill = "#005F83"
    )+
  geom_line(
    aes(
      y = percent_vacant*(1.05*max(history_vac$total, na.rm = T)),
      color = "Observed"
      ), 
    size=1.4
    )+
  geom_line(
    aes(
      y = percent_vacant_forecast*(1.05*max(history_vac$total, na.rm = T)),
      color = "Forecast"
      ), 
    size=1.4
    )+
  geom_point(
    aes(
      y = percent_vacant_forecast*(1.05*max(history_vac$total, na.rm = T)),
      color = "Forecast"
      ), 
    size = 3
    )+
  geom_point(
    aes(
      y = percent_vacant*(1.05*max(history_vac$total, na.rm = T)),
      color = "Observed"
      ), 
    size = 3
    )+
  scale_y_continuous(
    label = scales::unit_format(accuracy = 1, unit = "", sep = "", big.mark = ","),
    breaks = scales::pretty_breaks(4),
    sec.axis = sec_axis(
      ~. / (1.05*max(history_vac$total, na.rm = T)), 
      name = "Percentage of vacant premises", 
      labels = scales::percent_format(accuracy = 1)
      ),
    limits = c(
      min(history_vac$Vacancies,na.rm = T)-40000,
      max(history_vac$Vacancies, na.rm = T)+30000), 
    oob = scales::rescale_none
      )+
  scale_color_manual(values = c("#FFAA4D", "#00A499"))+
  ylab(
    "Total number of vacant premises"
    )+
  ggtitle(
    "Vacant premises"
    )+
theme_bw()+
  theme(
    plot.title = element_text(
      hjust = 0.5
      ),
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title.x  = element_blank())
    
  

```

> This chart shows the change in volume (bars) and % (line) of vacant premises, with a forecast for the next 3 months

\newpage
\blandscape

### Vacancy - Trading Party Level Reporting 

```{r, echo=FALSE, warning=FALSE, error=FALSE, fig.height=4.8, fig.width=10}

MOSLR::bubble_chart(df.vacancy = vacant, vacancy.graph = T, tp.details = tp_details, by = "Retailer", my.dir = my_dir) 

```

> This chart shows relative volumes of Vacant Premises by Retailer and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however theirpercentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r, echo=FALSE, warning=FALSE}
top10_vac_ret <- current_vac%>%
  arrange(
    desc(
      percent
      )
    )%>%
  mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = cell_spec(
      percent_temp,
      "latex",
      background = case_when(
         percent > vac_MO_avg$Total+0.02 ~ 
           "#F08080",
         percent > vac_MO_avg$Total-0.02 & percent < vac_MO_avg$Total+0.02 ~ 
           "#FFE699",
         percent < vac_MO_avg$Total-0.02 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"), escape = FALSE),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    Vacancies = scales::comma(Vacancies, digits = 0)
    )%>%
   select(Retailer, TotalPremises, Vacancies, percent_temp)




knitr::kable(top10_vac_ret,
  booktabs = TRUE,
  "latex",
  col.names = c("Retailer", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "",
  escape = F,
  caption = "Retailer Vacancy ranking",
  align = c("l", rep("r", ncol(top10_vac_ret)-1))
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  row_spec(
    1:nrow(top10_vac_ret),
    hline_after = T)
```


\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_vac,
  booktabs = TRUE,
  "latex",
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "scale_down")
    )%>%
  column_spec(1:3, width = "5cm")
```

\arrayrulecolor{black}

> Only Retailers with more than 200 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month

\newpage
\blandscape

```{r, echo=FALSE, warning=FALSE, error=FALSE, fig.width=10, fig.height=5.2}
MOSLR::bubble_chart(df.vacancy = vacant, vacancy.graph = T, tp.details = tp_details, by = "Wholesaler", my.dir = my_dir) 

```


> This chart shows relative volumes of Vacant Premises by Wholesaler area and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however theirpercentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r, echo=FALSE, warning=FALSE}

top10_vac_whole <- current_vac%>%
  mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = cell_spec(
      percent_temp,
      "latex",
      background = case_when(
         percent > vac_MO_avg$Total+0.02 ~ 
           "#F08080",
         percent > vac_MO_avg$Total-0.02 & percent < vac_MO_avg$Total+0.02 ~ 
           "#FFE699",
         percent < vac_MO_avg$Total-0.02 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"), escape = FALSE),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    Vacancies = scales::comma(Vacancies, digits = 0)
    )%>%
  arrange(
    desc(
      percent
      )
    )%>%mutate(percent = paste0(round(percent*100,1), "\\%"))%>%
  filter(
    !is.na(Total_Premises_april)
    )%>%
  select(Wholesaler, TotalPremises, Vacancies, percent_temp)




knitr::kable(top10_vac_whole,
  booktabs = TRUE,
      "latex",
  col.names = c("Wholesaler", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "",
  escape = F,
  caption = "Wholesaler area Vacancy ranking",
  align = c("l", rep("r", ncol(top10_vac_whole)-1))
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  row_spec(
    1:nrow(top10_vac_whole),
    hline_after = T)
```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE}

knitr::kable(table_legend_vac,
  booktabs = TRUE,
      "latex",
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "scale_down")
    )%>%
  column_spec(1:3, width = "5cm")
```

\arrayrulecolor{black}

> Only Wholesalers with more than 200 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month


\newpage
\blandscape

```{r, echo=FALSE, warning=FALSE, error=FALSE, fig.height=5.2, fig.width=10}
MOSLR::bubble_chart(df.vacancy = vacant, vacancy.graph = T, tp.details = tp_details, by = "Pair", my.dir = my_dir) 

```


> This chart shows relative volumes of Vacant Premises by Wholesaler-Retailer Pairing and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however theirpercentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r, echo=FALSE, warning=FALSE}
top10_vac_pair <- current_vac%>%
  arrange(
    desc(
      percent
      )
    )%>%
  mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = cell_spec(
      percent_temp,
      "latex",
      background = case_when(
         percent > vac_MO_avg$Total+0.02 ~ 
           "#F08080",
         percent > vac_MO_avg$Total-0.02 & percent < vac_MO_avg$Total+0.02 ~ 
           "#FFE699",
         percent < vac_MO_avg$Total-0.02 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"), escape = FALSE),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    Vacancies = scales::comma(Vacancies, digits = 0)
    )%>%
   select(Pair, TotalPremises, Vacancies, percent_temp)




knitr::kable(top10_vac_pair,
  booktabs = TRUE,
      "latex",
  col.names = c("Pairing", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "",
  escape = F,
  caption = "Pairing Vacancy ranking",
  align = c("l", rep("r", ncol(top10_vac_pair)-1))
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    ) %>%
  row_spec(
    1:nrow(top10_vac_pair),
    hline_after = T)%>%
  column_spec(
    1,
    width = "6.5cm"
    )
```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_vac,
  booktabs = TRUE,
      "latex",
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "scale_down")
    )%>%
  column_spec(1:3, width = "5cm")
```

\arrayrulecolor{black}

> Only Pairings with more than 6000 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month

\newpage
\blandscape



```{r, echo=FALSE, warning=FALSE}

vacant_current <- vacant%>%
      filter(
        Period == max(vacant$Period)
        )%>%
  mutate(
    percent = scales::percent(Vacancies/Premises)
    )

vac_TP_temp <- data.table::transpose(vacant_TP)
colnames(vac_TP_temp) <- vacant_TP$TradingPartyID

vacant_total <- pivot_wider(
  arrange(
    vacant_current, 
    WholesalerID),
  id_cols = WholesalerID, 
  names_from = RetailerID, 
  values_from = Vacancies
  )%>%
  bind_rows(., mutate_all(select(vac_TP_temp[3,], unique(vacant_current$RetailerID)), as.numeric))%>%
  left_join(., vacant_TP%>%select(TradingPartyID, Vacant_Premises), by = c("WholesalerID" = "TradingPartyID"))%>%
  rename(Total = Vacant_Premises)

vacant_total[nrow(vacant_total),1] <- "Total"
vacant_total[nrow(vacant_total), ncol(vacant_total)] <- vacant_Total$Total_Vacant_Premises

vacant_total <- vacant_total%>%
  mutate_if(
    is.numeric, ~scales::comma(., accuracy = 1)
  )%>%
  mutate_all(
    ~replace(., is.na(.),"")
    )  


  

  
writeData(wb, sheet = "Vacant_numbers", x = vacant_total)


knitr::kable(
  vacant_total,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Total number of vacant premises",
  align = c(
    "l",
    rep(
      "c", 
      ncol(vacant_total)-1)
    ),
  col.names = c("", colnames(vacant_total)[2:ncol(vacant_total)])
  )%>%
  kable_styling(
    bootstrap_options = "bordered",
    latex_options = c("hold_position", "scale_down", "striped"), stripe_color = "blizzardblue"
    )%>%
  column_spec(
    ncol(vacant_total)-1, 
    border_right = T
    )%>%
  row_spec(
    0, 
    angle = 90
    )%>%
  row_spec(
    nrow(vacant_total)-1, 
    hline_after = T
    )%>%
  row_spec(
    nrow(vacant_total), 
    bold = T
    )%>%
  column_spec(
    ncol(vacant_total),
    bold = T
    )
```


```{r, echo=FALSE, warning=FALSE}


vacant_percent <- pivot_wider(
    arrange(
      vacant_current, 
      WholesalerID),
    id_cols = WholesalerID,
    names_from = RetailerID, 
    values_from = percent
    )%>%
  bind_rows(., select(vac_TP_temp[4,], unique(vacant_current$RetailerID)))%>%
  left_join(., vacant_TP%>%select(TradingPartyID, percent), by = c("WholesalerID" = "TradingPartyID"))%>%
  mutate_all(
    ~replace(., is.na(.),"")
    )%>%
  rename(Total = percent)



vacant_percent[nrow(vacant_percent),1] <- "Total"
vacant_percent[nrow(vacant_percent), ncol(vacant_percent)] <- paste(round(100*vacant_Total$Market_Vacancy_Rate,1),"%")


writeData(wb, sheet = "Vacant_percent", x = vacant_percent)

knitr::kable(
  vacant_percent,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Percentage of vacant premises",
  align = c(
    "l", 
    rep(
      "c", 
      ncol(vacant_percent)-1)
    ),
  col.names = c(
    "", 
    colnames(vacant_percent)[2:ncol(vacant_percent)]
    )
  )%>%
  kable_styling(
    latex_options = c("hold_position", "scale_down", "striped"), stripe_color = "blizzardblue"
    )%>%
  column_spec(
    ncol(vacant_percent)-1, 
    border_right = T
    )%>%
  row_spec(
    0, 
    angle = 90
    )%>%
  row_spec(
    nrow(vacant_percent)-1, 
    hline_after = T
    )%>%
  row_spec(
    nrow(vacant_percent),
    bold = T
    )%>%
  column_spec(
    ncol(vacant_percent), 
    bold = T
    )
```

\elandscape
\clearpage




## B. Timely, Robust Consumption Data 

### Long Unread Meters - Market Level Reporting



```{r forecast1, echo=FALSE,  warning=FALSE, error=FALSE, fig.height=5}
history <- longunread%>%
  group_by(
    Period
    )%>%
  summarise(
    Meters_unread = sum(Meters_Unread_in_12mo),
    total = sum(Total_Meters),
    percent_unread = sum(Meters_Unread_in_12mo)/sum(Total_Meters)
    )%>%
  filter(
    Period > "2019-03-01"
    )

forecast <- lm(percent_unread~Period, data = history[(nrow(history)-4):nrow(history),])

predict <- data.frame(
  Period = c(
    max(history$Period)%m+%months(1),
    max(history$Period)%m+%months(2),
    max(history$Period)%m+%months(3)
    )
  )


predict$percent_unread_forecast <- predict.lm(forecast, predict)

history_w_forecast <- bind_rows(history, predict)

history_w_forecast$percent_unread_forecast[history_w_forecast$Period==max(history$Period)] <- history_w_forecast$percent_unread[history_w_forecast$Period==max(history$Period)]


ggplot(
  history_w_forecast, 
  aes(
    x = Period
    )
  )+
  geom_bar(
    aes(
      x=Period,
      y = Meters_unread
      ),
    stat = "identity",
    position = "dodge", 
    inherit.aes = FALSE,
    fill = "#005F83"
    )+
  geom_line(
    aes(
      y = percent_unread_forecast*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Forecast"
      ), 
    size=1.4
    )+
  geom_point(
    aes(
      y = percent_unread_forecast*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Forecast"
      ), 
    size=3
    )+
  geom_line(
    aes(
      y = percent_unread*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Observed"
      ), 
    size=1.4
    )+
  geom_point(
    aes(
      y = percent_unread*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Observed"
      ), 
    size=3
    )+
  scale_y_continuous(
    label = scales::unit_format(accuracy = 1, unit = "", sep = "", big.mark = ","),
    breaks = scales::pretty_breaks(4),
    sec.axis = sec_axis(
      ~. / (1.05*max(history_w_forecast$total, na.rm = T)), 
      name = "Percentage of meters unread", 
      labels = scales::percent_format(accuracy = 1)
      ),
    limits = c(min(history_w_forecast$Meters_unread,na.rm = T)-40000,max(history_w_forecast$Meters_unread, na.rm = T)+30000),
    oob = scales::rescale_none
    )+
  scale_color_manual(values = c("#FFAA4D", "#00A499"))+
  ylab(
    "Total number of meters unread"
    )+
  ggtitle(
    "Meters Unread for 12+ months"
    )+
  theme_bw()+
  theme(
    plot.title = element_text(
      hjust = 0.5
      ),
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title.x  = element_blank()
    )
  

```

> This chart shows the change in volume (bars) and % (line) of meters unread for at least 12 months, with a forecast for the next 3 months

\ 
\  


\newpage

```{r forecast2, echo=FALSE,  warning=FALSE, error=FALSE, fig.height=5}
history_MO <- longunread%>%
  group_by(
    Period
    )%>%
  summarise(
    Meters_Unread_Since_MO = sum(Meters_Unread_Since_MO),
    total = sum(Total_Meters),
    percent_unread_MO = sum(Meters_Unread_Since_MO)/sum(Total_Meters)
    )%>%
  filter(
    Period > "2019-03-01"
    )

forecast_MO <- lm(percent_unread_MO ~ Period, data = history_MO[(nrow(history_MO)-4):nrow(history_MO),])

predict_MO <- data.frame(
  Period = c(
    max(history_MO$Period)%m+%months(1),
    max(history_MO$Period)%m+%months(2),
    max(history_MO$Period)%m+%months(3)
    )
  )


predict_MO$percent_unread_MO_forecast <- predict.lm(forecast_MO, predict_MO)

history_MO_w_forecast <- bind_rows(history_MO, predict_MO)

history_MO_w_forecast$percent_unread_MO_forecast[history_MO_w_forecast$Period==max(history$Period)] <- history_MO_w_forecast$percent_unread_MO[history_MO_w_forecast$Period==max(history$Period)]



ggplot(
  history_MO_w_forecast, 
  aes(
    x = Period
    )
  )+
  geom_bar(
    aes(
      x=Period,
      y = Meters_Unread_Since_MO
      ),
    stat = "identity",
    position = "dodge", 
    inherit.aes = FALSE,
    fill = "#005F83"
    )+
  geom_line(
    aes(
      y = percent_unread_MO_forecast*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Forecast"
      ), 
    size=1.4
    )+
  geom_point(
    aes(
      y = percent_unread_MO_forecast*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Forecast"
      ), 
    size=3
    )+
  geom_line(
    aes(
      y = percent_unread_MO*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Observed"
      ), 
    size=1.4
    )+
  geom_point(
    aes(
      y = percent_unread_MO*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Observed"
      ), 
    size=3
    )+
  scale_y_continuous(
    label = scales::unit_format(accuracy = 1, unit = "", sep = "", big.mark = ","),
    breaks = scales::pretty_breaks(4),
    sec.axis = sec_axis(
      ~. / (1.1*max(history_MO_w_forecast$total, na.rm = T)), 
      name = "Percentage of meters unread", 
      labels = scales::percent_format(accuracy = 1)
      ),
    oob = scales::rescale_none
    )+
  scale_color_manual(values = c("#FFAA4D", "#00A499"))+
  ylab(
    "Total number of meters unread"
    )+
  ggtitle(
    "Meters Unread since Market Opening"
    )+
  theme_bw()+
  theme(
    plot.title = element_text(
      hjust = 0.5
      ),
    legend.title = element_blank(),
    legend.position = "bottom",
    axis.title.x  = element_blank()
    )
  

```

> This chart shows the change in volume (bars) and % (line) of meters unread for at least 12 months, with a forecast for the next 3 months

\  
\  

\newpage

\blandscape
### Long Unread Meters - Trading Party Level Reporting



```{r, echo=FALSE, warning=FALSE, error=FALSE, fig.height=4.8, fig.width=10}
MOSLR::bubble_chart(df.longunread = longunread, longunread.graph = T, tp.details = tp_details, by = "Retailer", my.dir = my_dir) 

```

> This chart shows relative volumes of Long Unread meters by Retailers and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Wholesaler areas are showing an increase proportionally in long unread meters and their percentage is higher than the market average
* **Improving** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still higher than the market average
* **At risk** (bottom right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still lower than the market average
* **Leading** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, and their percentage is lower than the market average



\newpage
\elandscape
\arrayrulecolor{black}

```{r, echo=FALSE, warning=FALSE}


top10_long_ret <- current_long%>%
  mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = cell_spec(
      percent_temp,
      "latex",
      background = case_when(
         percent > longunread_avg$Total ~ 
           "#F08080",
         percent>0.05 & percent < longunread_avg$Total ~ 
           "#FFe699",
         percent < 0.05 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"),
      escape = FALSE),
    TotalMeters = scales::comma(TotalMeters, digits = 0),
    PureLUMs = scales::comma(PureLUMs, digits = 0)
    )%>%
  arrange(
    desc(
      percent
      )
    )%>%
  select(Retailer, TotalMeters, PureLUMs, percent_temp)



knitr::kable(
  top10_long_ret,
  format = "latex",
  col.names = c("Retailer", "Total number of meters", "Number of Long unread meters", "Percentage of Long unread meters"),
  booktabs = TRUE,
  escape=F,
  linesep = "",
  caption = "Retailer Long unread ranking",
  align = c(
    "l", 
    rep(
      "r", 
      ncol(top10_long_ret)-1)
    )
  )%>%
  kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  row_spec(
    1:nrow(top10_long_ret),
    hline_after = T)



```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_long,
      "latex",
  booktabs = TRUE,
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "scale_down")
    )
```
\arrayrulecolor{black}

> Only Retailers with more than 100 meters are included here.  
> The arrows indicate the change in percentage of Long Unread meters compared to last month


\newpage
\blandscape

```{r bubble_chart_Whole, echo=FALSE, warning=FALSE, error=FALSE, fig.height=5.2, fig.width=10}
MOSLR::bubble_chart(df.longunread = longunread, longunread.graph = T, tp.details = tp_details, by = "Wholesaler", my.dir = my_dir) 


```

> This chart shows relative volumes of Long Unread meters by Wholesaler area and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Wholesaler areas are showing an increase proportionally in long unread meters and their percentage is higher than the market average
* **Improving** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still higher than the market average
* **At risk** (bottom right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still lower than the market average
* **Leading** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, and their percentage is lower than the market average


\newpage
\elandscape

```{r top10_whole, echo=FALSE, warning=FALSE}


top10_long_whole <- current_long%>%
  mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = cell_spec(
      percent_temp,
      "latex",
      background = case_when(
         percent > longunread_avg$Total ~ 
           "#F08080",
         percent>0.05 & percent < longunread_avg$Total ~ 
           "#FFe699",
         percent < 0.05 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"),
      escape = FALSE),
    TotalMeters = scales::comma(TotalMeters, digits = 0),
    PureLUMs = scales::comma(PureLUMs, digits = 0)
    )%>%
  arrange(
    desc(
      percent
      )
    )%>%
  select(Wholesaler, TotalMeters, PureLUMs, percent_temp)





knitr::kable(
  top10_long_whole,
      "latex",
  col.names = c("Wholesaler", "Total number of meters", "Number of Long unread meters", "Percentage of Long unread meters"),
  booktabs = TRUE,
  escape=F,
  linesep = "",
  caption = "Wholesaler area Long Unread ranking",
  align = c(
    "l", 
    rep(
      "r", 
      ncol(top10_long_whole)-1)
    )
  )%>%
  kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  row_spec(
    1:nrow(top10_long_whole),
    hline_after = T)


```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_long,
      "latex",
  booktabs = TRUE,
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "scale_down")
    )
```
\arrayrulecolor{black}

> Only Wholesaler areas with more than 100 meters are included here.  
> The arrows indicate the change in percentage of Long Unread meters compared to last month


\newpage

\blandscape

```{r,echo=FALSE, warning=FALSE, error=FALSE, fig.width=10, fig.height=5.2}

MOSLR::bubble_chart(df.longunread = longunread, longunread.graph = T, tp.details = tp_details, by = "Pair", my.dir = my_dir) 
 
```

> This chart shows relative volumes of Long Unread meters by Wholesaler-Retailer pairing and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Wholesaler areas are showing an increase proportionally in long unread meters and their percentage is higher than the market average
* **Improving** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still higher than the market average
* **At risk** (bottom right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still lower than the market average
* **Leading** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, and their percentage is lower than the market average


\newpage
\elandscape

```{r, echo=FALSE, warning=FALSE}


top10_long_pair <- current_long%>%
  mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = cell_spec(
      percent_temp,
      "latex",
      background = case_when(
         percent > longunread_avg$Total ~ 
           "#F08080",
         percent>0.05 & percent < longunread_avg$Total ~ 
           "#FFE699",
         percent < 0.05 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"),
      escape = FALSE),
    TotalMeters = scales::comma(TotalMeters, digits = 0),
    PureLUMs = scales::comma(PureLUMs, digits = 0)
    )%>%
  arrange(
    desc(
      percent
      )
    )%>%
  select(Pair, TotalMeters, PureLUMs, percent_temp)



knitr::kable(
  top10_long_pair,
      "latex",
  col.names = c("Pairing", "Total number of meters", "Number of Long unread meters", "Percentage of Long unread meters"),
  booktabs = TRUE,
  escape=F,
  linesep = "",
  caption = "Pairing Long unread ranking",
  align = c(
    "l", 
    rep(
      "r", 
      ncol(top10_long_ret)-1)
    )
  )%>%
  kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  row_spec(
    1:nrow(top10_long_pair),
    hline_after = T)%>%
  column_spec(
    1,
    width = "6.5cm"
    )



```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_long,
      "latex",
  booktabs = TRUE,
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kable_styling(
    latex_options = c("hold_position", "scale_down")
    )
```

\arrayrulecolor{black}

> Only Wholesaler-Retailer pairings with more than 3000 meters are included here.  
> The arrows indicate the change in percentage of Long Unread meters compared to last month


\clearpage
\newpage
\blandscape



```{r, echo=FALSE, warning=FALSE}
longunreadtotal <- pivot_wider(
  arrange(
    longunread%>%
      filter(
        Period == max(longunread$Period)
        ),
    WholesalerID),
  id_cols = WholesalerID, 
  names_from = RetailerID, 
  values_from = Meters_Unread_in_12mo
  )%>%
  bind_rows(
    summarise_all(
      ., 
      funs(if(is.numeric(.)) sum(., na.rm = TRUE) else "Total")
      )
    )%>%
  select(
    WholesalerID, 
    sort(names(.)
         )
    )%>%
  mutate(
    Total = rowSums(
      select(., -WholesalerID), 
      na.rm = T)
    )%>%
  mutate_if(
    is.numeric, ~scales::comma(., accuracy = 1)
  )%>%
  mutate_all(
    ~replace(
      ., 
      is.na(.),
      ""
      )
    )


knitr::kable(
  longunreadtotal,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Total number of meters unread in 12 months",
  align = 
    c(
      "l", 
      rep(
        "c", 
        ncol(longunreadtotal)-1
        )
      ),
  col.names = c(
    "", 
    colnames(longunreadtotal)[2:ncol(longunreadtotal)])
    ) %>%
  kable_styling(
    latex_options = c(
      "hold_position",
      "scale_down", 
      "striped"
      ),
    stripe_color = "blizzardblue"
    )%>%
  column_spec(
    ncol(longunreadtotal)-1, 
    border_right = T
    )%>%
  row_spec(
    0, 
    angle = 90
    )%>%
  row_spec(
    nrow(longunreadtotal)-1, 
    hline_after = T
    )%>%
  row_spec(
    nrow(longunreadtotal), 
    bold = T
    )%>%
  column_spec(
    ncol(longunreadtotal), 
    bold = T
    )
```


```{r, echo=FALSE, warning=FALSE}
longunreadtotal_Since_MO <- pivot_wider(
  arrange(
    longunread%>%
      filter(
        Period == max(longunread$Period)
        ),
    WholesalerID),
  id_cols = WholesalerID, 
  names_from = RetailerID, 
  values_from = Meters_Unread_Since_MO
  )%>%
  bind_rows(
    summarise_all(
      ., 
      funs(if(is.numeric(.)) sum(., na.rm = TRUE) else "Total")
      )
    )%>%
  select(
    WholesalerID, 
    sort(names(.)
         )
    )%>%
  mutate(
    Total = rowSums(
      select(., -WholesalerID), 
      na.rm = T)
    )%>%
  mutate_if(
    is.numeric, ~scales::comma(., accuracy = 1)
  )%>%
  mutate_all(
    ~replace(
      ., 
      is.na(.),
      ""
      )
    )


knitr::kable(
  longunreadtotal_Since_MO,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Total number of meters unread since Market Opening",
  align = 
    c(
      "l", 
      rep(
        "c", 
        ncol(longunreadtotal_Since_MO)-1
        )
      ),
  col.names = c(
    "", 
    colnames(longunreadtotal_Since_MO)[2:ncol(longunreadtotal_Since_MO)])
    ) %>%
  kable_styling(
    latex_options = c(
      "hold_position",
      "scale_down", 
      "striped"
      ),
    stripe_color = "blizzardblue"
    )%>%
  column_spec(
    ncol(longunreadtotal_Since_MO)-1, 
    border_right = T
    )%>%
  row_spec(
    0, 
    angle = 90
    )%>%
  row_spec(
    nrow(longunreadtotal_Since_MO)-1, 
    hline_after = T
    )%>%
  row_spec(
    nrow(longunreadtotal_Since_MO), 
    bold = T
    )%>%
  column_spec(
    ncol(longunreadtotal_Since_MO), 
    bold = T
    )
```


```{r, echo=FALSE, warning=FALSE}
percent <- longunread%>%
  filter(
    Period == max(longunread$Period)
    )%>%
  mutate(
    percent = scales::percent(
      Meters_Unread_in_12mo/Total_Meters)
    )%>%
  pivot_wider(
    ., 
    id_cols = WholesalerID,
    names_from = RetailerID, 
    values_from = percent
    )



total_percent <- longunread%>%
  filter(
    Period == max(longunread$Period)
    )%>%
  summarise(
    Total = paste(round(100*sum(Meters_Unread_in_12mo)/sum(Total_Meters),1),"%")
    )%>%
  mutate(
    WholesalerID = "Total"
    )



ret_percent <- longunread%>%
   filter(
     Period == max(longunread$Period)
     )%>%
  group_by(
    RetailerID
    )%>%
  summarise(
    percent = paste(round(100*sum(Meters_Unread_in_12mo)/sum(Total_Meters),1),"%")
    )%>%
  mutate(
    WholesalerID = "Total"
    )%>%
  pivot_wider(
    id_cols = WholesalerID, 
    names_from = RetailerID, 
    values_from = percent
    )


whole_percent <- longunread%>%
   filter(
     Period == max(longunread$Period)
     )%>%
  group_by(
    WholesalerID
    )%>%
  summarise(
    Total = paste(round(100*sum(Meters_Unread_in_12mo)/sum(Total_Meters),1),"%")
    )

unread_percent <- bind_rows(
  arrange(
    percent, 
    WholesalerID),
  ret_percent
  )%>%
  left_join(
    .,
    bind_rows(
      whole_percent, 
      total_percent
      ), 
    by = "WholesalerID"
    )%>%
  mutate_all(
    ~replace(., is.na(.),"")
    )


knitr::kable(
  unread_percent,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Percentage of meters unread in 12 months",
  align = c(
    "l", 
    rep(
      "c", 
      ncol(unread_percent)-1)
    ),
  col.names = c(
    "", 
    colnames(unread_percent)[2:ncol(unread_percent)]
    )
  )%>%
  kable_styling(
    latex_options = c("hold_position", "scale_down", "striped"),
    stripe_color = "blizzardblue"
    )%>%
  column_spec(
    ncol(unread_percent)-1, 
    border_right = T
    )%>%
  row_spec(
    0, 
    angle = 90
    )%>%
  row_spec(
    nrow(unread_percent)-1, 
    hline_after = T
    )%>%
  row_spec(
    nrow(unread_percent), 
    bold = T
    )%>%
  column_spec(
    ncol(unread_percent), 
    bold = T)

```

\newpage

\elandscape







