

```{r setup, include=FALSE}

`%m+%` <- lubridate::`%m+%`

table_legend_long <- data.frame(
  Red = "Above market average", 
  Yellow = "Below market average", 
  Green = "Below target market level"
  )%>%
  dplyr::mutate(
    Red = kableExtra::cell_spec(
      Red,
      "latex", 
      background = "#F08080",
    ),
    Yellow = kableExtra::cell_spec(
      Yellow,
      "latex", 
      background = "#FFE699",
    ),
    Green = kableExtra::cell_spec(
      Green,
      "latex", 
      background = "#C6E0B4",
    )
    )

table_legend_vac <- data.frame(
  Red = "More than 2.5% over Market Opening average", 
  Yellow = "Within $\\pm$ 2.5\\% of the Market Opening average", 
  Green = "More than 2.5% less than Market Opening average"
  )%>%
  dplyr::mutate(
    Red = kableExtra::cell_spec(
      Red,
      "latex", 
      background = "#F08080",
    ),
    Yellow = kableExtra::cell_spec(
      Yellow, 
      "latex",
      background = "#FFE699",
      escape = FALSE
    ),
    Green = kableExtra::cell_spec(
      Green,
      "latex",
      background = "#C6E0B4",
    )
    )

```


## A. High Quality Consumption & Asset Data

### Vacancy - Market Level Reporting 

```{r, echo=FALSE,  warning=FALSE, error=FALSE, fig.height=5}

history_vac <- vacant %>%
  dplyr::group_by(Period) %>%
  dplyr::summarise(
    VacantPremises = sum(VacantPremises),
    total = sum(Premises),
    percent_vacant = sum(VacantPremises) / sum(Premises)
    ) %>%
  dplyr::filter(Period > "2019-03-01")

forecast_vac <- lm(percent_vacant~Period, data = history_vac[(nrow(history_vac)-4):nrow(history_vac),])

predict_vac <- data.frame(
  Period = c(
    max(history_vac$Period) %m+% months(1),
    max(history_vac$Period) %m+% months(2),
    max(history_vac$Period) %m+% months(3)
    )
  )

predict_vac$percent_vacant_forecast <- predict.lm(forecast_vac, predict_vac)

history_vac_forecast <- dplyr::bind_rows(history_vac, predict_vac)

history_vac_forecast$percent_vacant_forecast[history_vac_forecast$Period==max(history_vac$Period)] <- history_vac_forecast$percent_vacant[history_vac_forecast$Period==max(history_vac$Period)]

ggplot2::ggplot(history_vac_forecast, ggplot2::aes(x = Period)) +
  ggplot2::geom_bar(ggplot2::aes(x = Period, y = VacantPremises), 
                    stat = "identity", position = "dodge", inherit.aes = FALSE, fill = "#005F83") +
  ggplot2::geom_line(ggplot2::aes(y = percent_vacant * (1.05 * max(history_vac$total, na.rm = TRUE)), 
                                  colour = "Observed"), size = 1.4) +
  ggplot2::geom_line(ggplot2::aes(y = percent_vacant_forecast * (1.05 * max(history_vac$total, na.rm = TRUE)), 
                                  colour = "Forecast"), size=1.4) +
  ggplot2::geom_point(ggplot2::aes(y = percent_vacant_forecast * (1.05 * max(history_vac$total, na.rm = TRUE)), 
                                   colour = "Forecast"), size = 3) +
  ggplot2::geom_point(ggplot2::aes(y = percent_vacant*(1.05*max(history_vac$total, na.rm = TRUE)), 
                                   colour = "Observed"), size = 3) +
  ggplot2::scale_y_continuous(
    label = scales::unit_format(accuracy = 1, unit = "", sep = "", big.mark = ","), 
    breaks = scales::pretty_breaks(4), 
    sec.axis = ggplot2::sec_axis(~. / (1.05*max(history_vac$total, na.rm = TRUE)), 
                                 name = "Percentage of vacant premises", labels = scales::percent_format(accuracy = 1)), 
    limits = c(
      min(history_vac$VacantPremises, na.rm = TRUE) - 40000,
      max(history_vac$VacantPremises, na.rm = TRUE) + 30000), 
    oob = scales::rescale_none) +
  ggplot2::scale_color_manual(values = c("#FFAA4D", "#00A499")) +
  ggplot2::ylab("Total number of vacant premises") +
  ggplot2::ggtitle("Vacant premises") +
  ggplot2::theme_bw() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5), 
    legend.title = ggplot2::element_blank(), 
    legend.position = "bottom", 
    axis.title.x  = ggplot2::element_blank()
    )
    
```

> This chart shows the change in volume (bars) and % (line) of vacant premises, with a forecast for the next 3 months

\newpage
\blandscape

### Vacancy - Trading Party Level Reporting 

```{r, echo=FALSE, warning=FALSE, error=FALSE, fig.height=4.8, fig.width=10}
    vac_MO_avg <- vacant%>%
      dplyr::filter(
        Period=="2017-04-01"
      )%>%
      dplyr::summarise(
        Total = sum(VacantPremises)/sum(Premises)
      )

graph_data <- MOSLR::MPOP_data_prep(df.vacancy =  vacant, tp.details = tp_details, vacancy.table = T, by = "Retailer", my.dir = my_dir)

MOSLR::bubble_chart(df = graph_data, vacancy.graph = T, by = "Retailer", vertical.sep = vac_MO_avg$Total) 

```

> This chart shows relative volumes of Vacant Premises by Retailer and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however theirpercentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r, echo=FALSE, warning=FALSE}
top10_vac_ret <- graph_data%>%
  dplyr::arrange(
    dplyr::desc(
      percent
      )
    )%>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp,
      "latex",
      background = dplyr::case_when(
         percent > vac_MO_avg$Total+0.02 ~ 
           "#F08080",
         percent > vac_MO_avg$Total-0.02 & percent < vac_MO_avg$Total+0.02 ~ 
           "#FFE699",
         percent < vac_MO_avg$Total-0.02 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"), escape = FALSE),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    VacantPremises = scales::comma(VacantPremises, digits = 0)
    )%>%
   dplyr::select(Retailer, TotalPremises, VacantPremises, percent_temp)




knitr::kable(top10_vac_ret,
  booktabs = TRUE,
  "latex",
  col.names = c("Retailer", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "",
  escape = F,
  caption = "Retailer Vacancy ranking",
  align = c("l", rep("r", ncol(top10_vac_ret)-1))
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  kableExtra::row_spec(
    1:nrow(top10_vac_ret),
    hline_after = T)
```


\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_vac,
  booktabs = TRUE,
  "latex",
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down")
    )%>%
  kableExtra::column_spec(1:3, width = "5cm")
```

\arrayrulecolor{black}

> Only Retailers with more than 200 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month

\newpage
\blandscape

```{r, echo=FALSE, warning=FALSE, error=FALSE, fig.width=10, fig.height=5.2}
graph_data <- MOSLR::MPOP_data_prep(df.vacancy =  vacant, tp.details = tp_details, vacancy.table = T, by = "Wholesaler", my.dir = my_dir)

MOSLR::bubble_chart(df = graph_data, vacancy.graph = T, by = "Wholesaler", vertical.sep = vac_MO_avg$Total) 

```


> This chart shows relative volumes of Vacant Premises by Wholesaler area and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however theirpercentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r, echo=FALSE, warning=FALSE}

top10_vac_whole <- graph_data%>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp,
      "latex",
      background = dplyr::case_when(
         percent > vac_MO_avg$Total+0.02 ~ 
           "#F08080",
         percent > vac_MO_avg$Total-0.02 & percent < vac_MO_avg$Total+0.02 ~ 
           "#FFE699",
         percent < vac_MO_avg$Total-0.02 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"), escape = FALSE),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    VacantPremises = scales::comma(VacantPremises, digits = 0)
    )%>%
  dplyr::arrange(
    dplyr::desc(
      percent
      )
    )%>%
  dplyr::mutate(percent = paste0(round(percent*100,1), "\\%"))%>%
  dplyr::filter(
    !is.na(Total_Premises_april)
    )%>%
  dplyr::select(Wholesaler, TotalPremises, VacantPremises, percent_temp)




knitr::kable(top10_vac_whole,
  booktabs = TRUE,
      "latex",
  col.names = c("Wholesaler", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "",
  escape = F,
  caption = "Wholesaler area Vacancy ranking",
  align = c("l", rep("r", ncol(top10_vac_whole)-1))
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  kableExtra::row_spec(
    1:nrow(top10_vac_whole),
    hline_after = T)
```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE}

knitr::kable(table_legend_vac,
  booktabs = TRUE,
      "latex",
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down")
    )%>%
  kableExtra::column_spec(1:3, width = "5cm")
```

\arrayrulecolor{black}

> Only Wholesalers with more than 200 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month


\newpage
\blandscape

```{r, echo=FALSE, warning=FALSE, error=FALSE, fig.height=5.2, fig.width=10}

graph_data <- MOSLR::MPOP_data_prep(df.vacancy =  vacant, tp.details = tp_details, vacancy.table = T, by = "Pair", my.dir = my_dir)

MOSLR::bubble_chart(df = graph_data, vacancy.graph = T, by = "Pair", vertical.sep = vac_MO_avg$Total) 

```


> This chart shows relative volumes of Vacant Premises by Wholesaler-Retailer Pairing and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Retailers are showing an increase in percentage of Vacant premises and their percentage is higher than the Expected level of Vacant premises
* **Improving** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, however their percentage is still higher than the Expected level of Vacant premises
* **At risk** (bottom right quadrant): Retailers are showing an increase in percentage of Vacant premises, however theirpercentage is still lower than the Expected level of Vacant premises
* **Leading** (top right quadrant): Retailers are showing a decrease in percentage of Vacant premises, and their percentage is lower than the Expected level of Vacant premises

\clearpage
\newpage
\elandscape

```{r, echo=FALSE, warning=FALSE}
top10_vac_pair <- graph_data%>%
  dplyr::arrange(
    dplyr::desc(
      percent
      )
    )%>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp,
      "latex",
      background = dplyr::case_when(
         percent > vac_MO_avg$Total+0.02 ~ 
           "#F08080",
         percent > vac_MO_avg$Total-0.02 & percent < vac_MO_avg$Total+0.02 ~ 
           "#FFE699",
         percent < vac_MO_avg$Total-0.02 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"), escape = FALSE),
    TotalPremises = scales::comma(TotalPremises, digits = 0),
    VacantPremises = scales::comma(VacantPremises, digits = 0)
    )%>%
   dplyr::select(Pair, TotalPremises, VacantPremises, percent_temp)




knitr::kable(top10_vac_pair,
  booktabs = TRUE,
      "latex",
  col.names = c("Pairing", "Total number of premises", "Total number of vacant premises", "Percentage of vacant premises"),
  linesep = "",
  escape = F,
  caption = "Pairing Vacancy ranking",
  align = c("l", rep("r", ncol(top10_vac_pair)-1))
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    ) %>%
  kableExtra::row_spec(
    1:nrow(top10_vac_pair),
    hline_after = T)%>%
  kableExtra::column_spec(
    1,
    width = "6.5cm"
    )
```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_vac,
  booktabs = TRUE,
      "latex",
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down")
    )%>%
  kableExtra::column_spec(1:3, width = "5cm")
```

\arrayrulecolor{black}

> Only Pairings with more than 6000 Premises are included here.  
> The arrows indicate the change in percentage of Vacant premises compared to last month

\newpage
\blandscape



```{r, echo=FALSE, warning=FALSE}

vacant_current <- vacant%>%
      dplyr::filter(
        Period == max(vacant$Period)
        ) %>%
  dplyr::mutate(
    percent = scales::percent(VacantPremises/Premises)
    )

vac_TP_temp <- data.table::transpose(vacant_TP)
colnames(vac_TP_temp) <- vacant_TP$TradingPartyID

vacant_total <- tidyr::pivot_wider(
  dplyr::arrange(
    vacant_current, 
    WholesalerID),
  id_cols = WholesalerID, 
  names_from = RetailerID, 
  values_from = VacantPremises
  )%>%
  dplyr::bind_rows(dplyr::mutate_all(dplyr::select(vac_TP_temp[3,], unique(vacant_current$RetailerID)), as.numeric))%>%
  dplyr::left_join(vacant_TP%>%dplyr::select(TradingPartyID, Vacant_Premises), by = c("WholesalerID" = "TradingPartyID"))%>%
  dplyr::rename(Total = Vacant_Premises)

vacant_total[nrow(vacant_total),1] <- "Total"
vacant_total[nrow(vacant_total), ncol(vacant_total)] <- vacant_Total$Total_Vacant_Premises

vacant_total <- vacant_total%>%
  dplyr::mutate_if(
    is.numeric, ~scales::comma(., accuracy = 1)
  )%>%
  dplyr::mutate_all(
    ~replace(., is.na(.),"")
    )  


knitr::kable(
  vacant_total,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Total number of vacant premises",
  align = c(
    "l",
    rep(
      "c", 
      ncol(vacant_total)-1)
    ),
  col.names = c("", colnames(vacant_total)[2:ncol(vacant_total)])
  )%>%
  kableExtra::kable_styling(
    bootstrap_options = "bordered",
    latex_options = c("hold_position", "scale_down", "striped"), stripe_color = "blizzardblue"
    )%>%
  kableExtra::column_spec(
    ncol(vacant_total)-1, 
    border_right = T
    )%>%
  kableExtra::row_spec(
    0, 
    angle = 90
    )%>%
  kableExtra::row_spec(
    nrow(vacant_total)-1, 
    hline_after = T
    )%>%
  kableExtra::row_spec(
    nrow(vacant_total), 
    bold = T
    )%>%
  kableExtra::column_spec(
    ncol(vacant_total),
    bold = T
    )
```


```{r, echo=FALSE, warning=FALSE}


vacant_percent <- tidyr::pivot_wider(
    dplyr::arrange(
      vacant_current, 
      WholesalerID),
    id_cols = WholesalerID,
    names_from = RetailerID, 
    values_from = percent
    )%>%
  dplyr::bind_rows(dplyr::select(vac_TP_temp[4,], unique(vacant_current$RetailerID)))%>%
  dplyr::left_join(vacant_TP%>%dplyr::select(TradingPartyID, percent), by = c("WholesalerID" = "TradingPartyID"))%>%
  dplyr::mutate_all(
    ~replace(., is.na(.),"")
    )%>%
  dplyr::rename(Total = percent)


vacant_percent[nrow(vacant_percent),1] <- "Total"
vacant_percent[nrow(vacant_percent), ncol(vacant_percent)] <- paste(round(100*vacant_Total$Market_Vacancy_Rate,1),"%")


knitr::kable(
  vacant_percent,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Percentage of vacant premises",
  align = c(
    "l", 
    rep(
      "c", 
      ncol(vacant_percent)-1)
    ),
  col.names = c(
    "", 
    colnames(vacant_percent)[2:ncol(vacant_percent)]
    )
  )%>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down", "striped"), stripe_color = "blizzardblue"
    )%>%
  kableExtra::column_spec(
    ncol(vacant_percent)-1, 
    border_right = T
    )%>%
  kableExtra::row_spec(
    0, 
    angle = 90
    )%>%
  kableExtra::row_spec(
    nrow(vacant_percent)-1, 
    hline_after = T
    )%>%
  kableExtra::row_spec(
    nrow(vacant_percent),
    bold = T
    )%>%
  kableExtra::column_spec(
    ncol(vacant_percent), 
    bold = T
    )
```

\elandscape
\clearpage




## B. Timely, Robust Consumption Data 

### Long Unread Meters - Market Level Reporting



```{r forecast1, echo=FALSE,  warning=FALSE, error=FALSE, fig.height=5}
history <- longunread%>%
  dplyr::group_by(
    Period
    )%>%
  dplyr::summarise(
    Meters_unread = sum(Meters_Unread_in_12mo),
    total = sum(TotalMeters),
    percent_unread = sum(Meters_Unread_in_12mo)/sum(TotalMeters)
    )%>%
  dplyr::filter(
    Period > "2019-03-01"
    )

forecast <- lm(percent_unread~Period, data = history[(nrow(history)-4):nrow(history),])

predict <- data.frame(
  Period = c(
    max(history$Period)%m+%months(1),
    max(history$Period)%m+%months(2),
    max(history$Period)%m+%months(3)
    )
  )


predict$percent_unread_forecast <- predict.lm(forecast, predict)

history_w_forecast <- dplyr::bind_rows(history, predict)

history_w_forecast$percent_unread_forecast[history_w_forecast$Period==max(history$Period)] <- history_w_forecast$percent_unread[history_w_forecast$Period==max(history$Period)]


ggplot2::ggplot(history_w_forecast, ggplot2::aes(x = Period)) +
  ggplot2::geom_bar(ggplot2::aes(x = Period, y = Meters_unread), stat = "identity", 
                    position = "dodge", inherit.aes = FALSE,fill = "#005F83") +
  ggplot2::geom_line(ggplot2::aes(y = percent_unread_forecast*(1.05*max(history_w_forecast$total, na.rm = TRUE)), 
                                  colour = "Forecast"), size = 1.4) +
  ggplot2::geom_point(ggplot2::aes(y = percent_unread_forecast*(1.05*max(history_w_forecast$total, na.rm = TRUE)),
                                   colour = "Forecast"), size=3) +
  ggplot2::geom_line(ggplot2::aes(y = percent_unread*(1.05*max(history_w_forecast$total, na.rm = TRUE)),
                                  colour = "Observed"), size = 1.4) +
  ggplot2::geom_point(ggplot2::aes(y = percent_unread * (1.05 * max(history_w_forecast$total, na.rm = TRUE)),
                                   colour = "Observed"), size = 3) +
  ggplot2::scale_y_continuous(
    label = scales::unit_format(accuracy = 1, unit = "", sep = "", big.mark = ","),
    breaks = scales::pretty_breaks(4),
    sec.axis = ggplot2::sec_axis(
      ~. / (1.05*max(history_w_forecast$total, na.rm = TRUE)), 
      name = "Percentage of meters unread", 
      labels = scales::percent_format(accuracy = 1)
      ),
    limits = c(
      min(history_w_forecast$Meters_unread,na.rm = TRUE) - 40000, 
      max(history_w_forecast$Meters_unread, na.rm = TRUE) + 30000),
    oob = scales::rescale_none
    ) +
  ggplot2::scale_color_manual(values = c("#FFAA4D", "#00A499")) +
  ggplot2::ylab("Total number of meters unread") +
  ggplot2::ggtitle("Meters Unread for 12+ months") +
  ggplot2::theme_bw()+
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5),
    legend.title = ggplot2::element_blank(),
    legend.position = "bottom",
    axis.title.x  = ggplot2::element_blank()
    )
  

```

> This chart shows the change in volume (bars) and % (line) of meters unread for at least 12 months, with a forecast for the next 3 months

\ 
\  


\newpage

```{r forecast2, echo=FALSE,  warning=FALSE, error=FALSE, fig.height=5}

history_MO <- longunread %>%
  dplyr::group_by(Period) %>%
  dplyr::summarise(
    Meters_Unread_Since_MO = sum(Meters_Unread_Since_MO),
    total = sum(TotalMeters),
    percent_unread_MO = sum(Meters_Unread_Since_MO) / sum(TotalMeters)
    ) %>%
  dplyr::filter(Period > "2019-03-01")

forecast_MO <- lm(percent_unread_MO ~ Period, data = history_MO[(nrow(history_MO)-4):nrow(history_MO),])

predict_MO <- data.frame(
  Period = c(
    max(history_MO$Period) %m+% months(1),
    max(history_MO$Period) %m+% months(2),
    max(history_MO$Period) %m+% months(3)
    )
  )


predict_MO$percent_unread_MO_forecast <- predict.lm(forecast_MO, predict_MO)

history_MO_w_forecast <- dplyr::bind_rows(history_MO, predict_MO)

history_MO_w_forecast$percent_unread_MO_forecast[history_MO_w_forecast$Period==max(history$Period)] <- history_MO_w_forecast$percent_unread_MO[history_MO_w_forecast$Period==max(history$Period)]



ggplot2::ggplot(
  history_MO_w_forecast, 
  ggplot2::aes(
    x = Period
    )
  )+
  ggplot2::geom_bar(
    ggplot2::aes(
      x=Period,
      y = Meters_Unread_Since_MO
      ),
    stat = "identity",
    position = "dodge", 
    inherit.aes = FALSE,
    fill = "#005F83"
    )+
  ggplot2::geom_line(
    ggplot2::aes(
      y = percent_unread_MO_forecast*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Forecast"
      ), 
    size=1.4
    )+
  ggplot2::geom_point(
    ggplot2::aes(
      y = percent_unread_MO_forecast*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Forecast"
      ), 
    size=3
    )+
  ggplot2::geom_line(
    ggplot2::aes(
      y = percent_unread_MO*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Observed"
      ), 
    size=1.4
    )+
  ggplot2::geom_point(
    ggplot2::aes(
      y = percent_unread_MO*(1.05*max(history_w_forecast$total, na.rm = T)),
      color="Observed"
      ), 
    size=3
    )+
  ggplot2::scale_y_continuous(
    label = scales::unit_format(accuracy = 1, unit = "", sep = "", big.mark = ","),
    breaks = scales::pretty_breaks(4),
    sec.axis = ggplot2::sec_axis(
      ~. / (1.1*max(history_MO_w_forecast$total, na.rm = T)), 
      name = "Percentage of meters unread", 
      labels = scales::percent_format(accuracy = 1)
      ),
    oob = scales::rescale_none
    )+
  ggplot2::scale_color_manual(values = c("#FFAA4D", "#00A499"))+
  ggplot2::ylab(
    "Total number of meters unread"
    )+
  ggplot2::ggtitle(
    "Meters Unread since Market Opening"
    )+
  ggplot2::theme_bw()+
  ggplot2::theme(
    plot.title = ggplot2::element_text(
      hjust = 0.5
      ),
    legend.title = ggplot2::element_blank(),
    legend.position = "bottom",
    axis.title.x  = ggplot2::element_blank()
    )
  

```

> This chart shows the change in volume (bars) and % (line) of meters unread for at least 12 months, with a forecast for the next 3 months

\  
\  

\newpage

\blandscape
### Long Unread Meters - Trading Party Level Reporting



```{r, echo=FALSE, warning=FALSE, error=FALSE, fig.height=4.8, fig.width=10}
    longunread_avg <- longunread%>%
      dplyr::filter(Period == max(longunread$Period))%>%
      dplyr::summarise(Total = sum(Meters_Unread_in_12mo)/sum(TotalMeters))

graph_data <- MOSLR::MPOP_data_prep(df.longunread = longunread,tp.details = tp_details, longunread.table = T, by = "Retailer", my.dir = my_dir)

MOSLR::bubble_chart(df = graph_data, longunread.graph = T, by = "Retailer", vertical.sep = longunread_avg$Total) 

```

> This chart shows relative volumes of Long Unread meters by Retailers and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Wholesaler areas are showing an increase proportionally in long unread meters and their percentage is higher than the market average
* **Improving** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still higher than the market average
* **At risk** (bottom right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still lower than the market average
* **Leading** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, and their percentage is lower than the market average



\newpage
\elandscape
\arrayrulecolor{black}

```{r, echo=FALSE, warning=FALSE}


top10_long_ret <- graph_data%>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp,
      "latex",
      background = dplyr::case_when(
         percent > longunread_avg$Total ~ 
           "#F08080",
         percent>0.05 & percent < longunread_avg$Total ~ 
           "#FFe699",
         percent < 0.05 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"),
      escape = FALSE),
    TotalMeters = scales::comma(TotalMeters, digits = 0),
    PureLUMs = scales::comma(PureLUMs, digits = 0)
    )%>%
  dplyr::arrange(
    dplyr::desc(
      percent
      )
    )%>%
  dplyr::select(Retailer, TotalMeters, PureLUMs, percent_temp)



knitr::kable(
  top10_long_ret,
  format = "latex",
  col.names = c("Retailer", "Total number of meters", "Number of Long unread meters", "Percentage of Long unread meters"),
  booktabs = TRUE,
  escape=F,
  linesep = "",
  caption = "Retailer Long unread ranking",
  align = c(
    "l", 
    rep(
      "r", 
      ncol(top10_long_ret)-1)
    )
  )%>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  kableExtra::row_spec(
    1:nrow(top10_long_ret),
    hline_after = T)



```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_long,
      "latex",
  booktabs = TRUE,
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down")
    )
```
\arrayrulecolor{black}

> Only Retailers with more than 100 meters are included here.  
> The arrows indicate the change in percentage of Long Unread meters compared to last month


\newpage
\blandscape

```{r bubble_chart_Whole, echo=FALSE, warning=FALSE, error=FALSE, fig.height=5.2, fig.width=10}

graph_data <- MOSLR::MPOP_data_prep(df.longunread = longunread, tp.details = tp_details, longunread.table = T, by = "Wholesaler", my.dir = my_dir)

MOSLR::bubble_chart(df = graph_data, longunread.graph = T, by = "Wholesaler", vertical.sep = longunread_avg$Total) 


```

> This chart shows relative volumes of Long Unread meters by Wholesaler area and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Wholesaler areas are showing an increase proportionally in long unread meters and their percentage is higher than the market average
* **Improving** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still higher than the market average
* **At risk** (bottom right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still lower than the market average
* **Leading** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, and their percentage is lower than the market average


\newpage
\elandscape

```{r top10_whole, echo=FALSE, warning=FALSE}


top10_long_whole <- graph_data%>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp,
      "latex",
      background = dplyr::case_when(
         percent > longunread_avg$Total ~ 
           "#F08080",
         percent>0.05 & percent < longunread_avg$Total ~ 
           "#FFe699",
         percent < 0.05 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"),
      escape = FALSE),
    TotalMeters = scales::comma(TotalMeters, digits = 0),
    PureLUMs = scales::comma(PureLUMs, digits = 0)
    )%>%
  dplyr::arrange(
    dplyr::desc(
      percent
      )
    )%>%
  dplyr::select(Wholesaler, TotalMeters, PureLUMs, percent_temp)





knitr::kable(
  top10_long_whole,
      "latex",
  col.names = c("Wholesaler", "Total number of meters", "Number of Long unread meters", "Percentage of Long unread meters"),
  booktabs = TRUE,
  escape=F,
  linesep = "",
  caption = "Wholesaler area Long Unread ranking",
  align = c(
    "l", 
    rep(
      "r", 
      ncol(top10_long_whole)-1)
    )
  )%>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  kableExtra::row_spec(
    1:nrow(top10_long_whole),
    hline_after = T)


```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_long,
      "latex",
  booktabs = TRUE,
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down")
    )
```
\arrayrulecolor{black}

> Only Wholesaler areas with more than 100 meters are included here.  
> The arrows indicate the change in percentage of Long Unread meters compared to last month


\newpage

\blandscape

```{r,echo=FALSE, warning=FALSE, error=FALSE, fig.width=10, fig.height=5.2}

graph_data <- MOSLR::MPOP_data_prep(df.longunread = longunread,tp.details = tp_details, longunread.table = T, by = "Pair", my.dir = my_dir)

MOSLR::bubble_chart(df = graph_data, longunread.graph = T, by = "Pair", vertical.sep = longunread_avg$Total) 
 
```

> This chart shows relative volumes of Long Unread meters by Wholesaler-Retailer pairing and their movement over the past 12 months.  

* **Declining** (bottom left quadrant): Wholesaler areas are showing an increase proportionally in long unread meters and their percentage is higher than the market average
* **Improving** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still higher than the market average
* **At risk** (bottom right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, however their percentage is still lower than the market average
* **Leading** (top right quadrant):  Wholesaler areas are showing a decrease proportionally in long unread meters, and their percentage is lower than the market average


\newpage
\elandscape

```{r, echo=FALSE, warning=FALSE}


top10_long_pair <- graph_data%>%
  dplyr::mutate(
    percent_temp = ifelse(
      percent - last_percent > 0, 
      paste0(round(percent*100, 1), "\\% $\\uparrow$"), 
      paste0(round(percent*100, 1), "\\% $\\downarrow$")
      ),
    percent_temp = kableExtra::cell_spec(
      percent_temp,
      "latex",
      background = dplyr::case_when(
         percent > longunread_avg$Total ~ 
           "#F08080",
         percent>0.05 & percent < longunread_avg$Total ~ 
           "#FFE699",
         percent < 0.05 ~ 
           "#C6E0B4",
         TRUE ~ "#FFFFFF"),
      escape = FALSE),
    TotalMeters = scales::comma(TotalMeters, digits = 0),
    PureLUMs = scales::comma(PureLUMs, digits = 0)
    )%>%
  dplyr::arrange(
    dplyr::desc(
      percent
      )
    )%>%
  dplyr::select(Pair, TotalMeters, PureLUMs, percent_temp)



knitr::kable(
  top10_long_pair,
      "latex",
  col.names = c("Pairing", "Total number of meters", "Number of Long unread meters", "Percentage of Long unread meters"),
  booktabs = TRUE,
  escape=F,
  linesep = "",
  caption = "Pairing Long unread ranking",
  align = c(
    "l", 
    rep(
      "r", 
      ncol(top10_long_ret)-1)
    )
  )%>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "striped", "scale_down")
    )%>%
  kableExtra::row_spec(
    1:nrow(top10_long_pair),
    hline_after = T)%>%
  kableExtra::column_spec(
    1,
    width = "6.5cm"
    )



```

\arrayrulecolor{white}

```{r, echo=FALSE, warning=FALSE }

knitr::kable(table_legend_long,
      "latex",
  booktabs = TRUE,
  col.names = c("", " ", " "),
  linesep = "",
  escape = F
    ) %>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down")
    )
```

\arrayrulecolor{black}

> Only Wholesaler-Retailer pairings with more than 3000 meters are included here.  
> The arrows indicate the change in percentage of Long Unread meters compared to last month


\clearpage
\newpage
\blandscape



```{r, echo=FALSE, warning=FALSE}
longunreadtotal <- tidyr::pivot_wider(
  dplyr::arrange(
    longunread%>%
      dplyr::filter(
        Period == max(longunread$Period)
        ),
    WholesalerID),
  id_cols = WholesalerID, 
  names_from = RetailerID, 
  values_from = Meters_Unread_in_12mo
  )%>%
  dplyr::bind_rows(
    dplyr::summarise_all(
      ., 
      dplyr::funs(if(is.numeric(.)) sum(., na.rm = TRUE) else "Total")
      )
    )%>%
  dplyr::select(
    WholesalerID, 
    sort(names(.)
         )
    )%>%
  dplyr::mutate(
    Total = rowSums(
      dplyr::select(., -WholesalerID), 
      na.rm = T)
    )%>%
  dplyr::mutate_if(
    is.numeric, ~scales::comma(., accuracy = 1)
  )%>%
  dplyr::mutate_all(
    ~replace(
      ., 
      is.na(.),
      ""
      )
    )


knitr::kable(
  longunreadtotal,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Total number of meters unread in 12 months",
  align = 
    c(
      "l", 
      rep(
        "c", 
        ncol(longunreadtotal)-1
        )
      ),
  col.names = c(
    "", 
    colnames(longunreadtotal)[2:ncol(longunreadtotal)])
    ) %>%
  kableExtra::kable_styling(
    latex_options = c(
      "hold_position",
      "scale_down", 
      "striped"
      ),
    stripe_color = "blizzardblue"
    )%>%
  kableExtra::column_spec(
    ncol(longunreadtotal)-1, 
    border_right = T
    )%>%
  kableExtra::row_spec(
    0, 
    angle = 90
    )%>%
  kableExtra::row_spec(
    nrow(longunreadtotal)-1, 
    hline_after = T
    )%>%
  kableExtra::row_spec(
    nrow(longunreadtotal), 
    bold = T
    )%>%
  kableExtra::column_spec(
    ncol(longunreadtotal), 
    bold = T
    )
```


```{r, echo=FALSE, warning=FALSE}
longunreadtotal_Since_MO <- tidyr::pivot_wider(
  dplyr::arrange(
    longunread%>%
      dplyr::filter(
        Period == max(longunread$Period)
        ),
    WholesalerID),
  id_cols = WholesalerID, 
  names_from = RetailerID, 
  values_from = Meters_Unread_Since_MO
  )%>%
  dplyr::bind_rows(
    dplyr::summarise_all(
      ., 
      dplyr::funs(if(is.numeric(.)) sum(., na.rm = TRUE) else "Total")
      )
    )%>%
  dplyr::select(
    WholesalerID, 
    sort(names(.)
         )
    )%>%
  dplyr::mutate(
    Total = rowSums(
      dplyr::select(., -WholesalerID), 
      na.rm = T)
    )%>%
  dplyr::mutate_if(
    is.numeric, ~scales::comma(., accuracy = 1)
  )%>%
  dplyr::mutate_all(
    ~replace(
      ., 
      is.na(.),
      ""
      )
    )


knitr::kable(
  longunreadtotal_Since_MO,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Total number of meters unread since Market Opening",
  align = 
    c(
      "l", 
      rep(
        "c", 
        ncol(longunreadtotal_Since_MO)-1
        )
      ),
  col.names = c(
    "", 
    colnames(longunreadtotal_Since_MO)[2:ncol(longunreadtotal_Since_MO)])
    ) %>%
  kableExtra::kable_styling(
    latex_options = c(
      "hold_position",
      "scale_down", 
      "striped"
      ),
    stripe_color = "blizzardblue"
    )%>%
  kableExtra::column_spec(
    ncol(longunreadtotal_Since_MO)-1, 
    border_right = T
    )%>%
  kableExtra::row_spec(
    0, 
    angle = 90
    )%>%
  kableExtra::row_spec(
    nrow(longunreadtotal_Since_MO)-1, 
    hline_after = T
    )%>%
  kableExtra::row_spec(
    nrow(longunreadtotal_Since_MO), 
    bold = T
    )%>%
  kableExtra::column_spec(
    ncol(longunreadtotal_Since_MO), 
    bold = T
    )
```


```{r, echo=FALSE, warning=FALSE}
percent <- longunread%>%
  dplyr::filter(
    Period == max(longunread$Period)
    )%>%
  dplyr::mutate(
    percent = scales::percent(
      Meters_Unread_in_12mo/TotalMeters)
    )%>%
  tidyr::pivot_wider(
    ., 
    id_cols = WholesalerID,
    names_from = RetailerID, 
    values_from = percent
    )



total_percent <- longunread%>%
  dplyr::filter(
    Period == max(longunread$Period)
    )%>%
  dplyr::summarise(
    Total = paste(round(100*sum(Meters_Unread_in_12mo)/sum(TotalMeters),1),"%")
    )%>%
  dplyr::mutate(
    WholesalerID = "Total"
    )



ret_percent <- longunread%>%
   dplyr::filter(
     Period == max(longunread$Period)
     )%>%
  dplyr::group_by(RetailerID)%>%
  dplyr::summarise(
    percent = paste(round(100*sum(Meters_Unread_in_12mo)/sum(TotalMeters),1),"%")
    )%>%
  dplyr::mutate(
    WholesalerID = "Total"
    )%>%
  tidyr::pivot_wider(
    id_cols = WholesalerID, 
    names_from = RetailerID, 
    values_from = percent
    )


whole_percent <- longunread%>%
   dplyr::filter(
     Period == max(longunread$Period)
     )%>%
  dplyr::group_by(
    WholesalerID
    )%>%
  dplyr::summarise(
    Total = paste(round(100*sum(Meters_Unread_in_12mo)/sum(TotalMeters),1),"%")
    )

unread_percent <- dplyr::bind_rows(
  dplyr::arrange(
    percent, 
    WholesalerID),
  ret_percent
  )%>%
  dplyr::left_join(
    dplyr::bind_rows(
      whole_percent, 
      total_percent
      ), 
    by = "WholesalerID"
    )%>%
  dplyr::mutate_all(
    ~replace(., is.na(.),"")
    )


knitr::kable(
  unread_percent,
      "latex",
  booktabs = TRUE,
  linesep = "",
  caption = "Percentage of meters unread in 12 months",
  align = c(
    "l", 
    rep(
      "c", 
      ncol(unread_percent)-1)
    ),
  col.names = c(
    "", 
    colnames(unread_percent)[2:ncol(unread_percent)]
    )
  )%>%
  kableExtra::kable_styling(
    latex_options = c("hold_position", "scale_down", "striped"),
    stripe_color = "blizzardblue"
    )%>%
  kableExtra::column_spec(
    ncol(unread_percent)-1, 
    border_right = T
    )%>%
  kableExtra::row_spec(
    0, 
    angle = 90
    )%>%
  kableExtra::row_spec(
    nrow(unread_percent)-1, 
    hline_after = T
    )%>%
  kableExtra::row_spec(
    nrow(unread_percent), 
    bold = T
    )%>%
  kableExtra::column_spec(
    ncol(unread_percent), 
    bold = T)

```

\newpage

\elandscape







