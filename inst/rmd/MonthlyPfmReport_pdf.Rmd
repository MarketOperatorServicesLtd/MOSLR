---
title: 'Portfolio Manager Report: `r paste0(TRADING.PARTY.NAME, " (",TRADING.PARTY,")")`'
date: "`r format(Sys.Date(), '%B %Y')`"
fontsize: 12pt
output:
  pdf_document:
    fig_height: 3.2
    fig_width: 8
    number_section: yes
    toc: yes
    fig_caption: true
header-includes:
- \usepackage{titling}
- \pretitle{\begin{center}\LARGE\includegraphics[width=24cm]{mosl_title.png}\\[\bigskipamount]}
- \posttitle{\end{center}}
- \usepackage{xcolor}
- \usepackage{color}
- \usepackage{fancyhdr}
- \usepackage{graphicx}
- \usepackage{eurosym}
- \usepackage{longtable}
- \usepackage{booktabs}
- \usepackage{makecell}
- \usepackage{pdflscape}
- \usepackage{multirow}
- \pagestyle{fancy}
- \fancyhf{}
- \lfoot{MOSL Portfolio Manager Report}
- \rhead{\includegraphics[width=6cm]{mosl_header.png}}
- \rfoot{Page \thepage}
classoption: table
---

```{r global_options, include = FALSE} 

knitr::opts_chunk$set(
  fig.width = 12, 
  fig.height = 7, 
  fig.path = 'Figs/',
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE
  )

```

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE}

mps_data_clean_temp <- mps_data_clean %>% 
  dplyr::filter(Trading.Party.ID == TRADING.PARTY) %>%
  droplevels()

mps_data_melt_temp <- mps_data_melt %>%
  dplyr::filter(Trading.Party.ID == TRADING.PARTY) %>%
  droplevels()

perf_status_mps_temp <- perf_status_mps %>%
  dplyr::filter(
    Trading.Party.ID == TRADING.PARTY,
    Date == data.period
    ) %>%
  droplevels()

```

# Market Performance Standards

## Performance Charges

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE}

mps_data_clean_temp %>%
  dplyr::select(
    Trading.Party.ID, Date, MPS, Charges
    ) %>%
  ggplot2::ggplot(
    ggplot2::aes(x = Date, y = Charges, fill = MPS)
    ) + 
  ggplot2::geom_bar(stat = "identity") + 
  ggplot2::theme(
    legend.title = ggplot2::element_blank(),
    text = ggplot2::element_text(size = 20)
    ) +
  ggplot2::scale_y_continuous(
    labels = scales::comma,
    breaks = scales::pretty_breaks(4)
    ) +
  ggplot2::labs(
    title = "Performance Charges",
    subtitle = "Breakdown of by month and standard",
    caption = "Source: MOSL"
    ) +
  ggplot2::ylab("Charges (£)") + ggplot2::xlab("")

```

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE}

# Creating table of charges by MPS ---------------- 

mps_data_clean_temp %>%
  dplyr::filter(
    Date >= max(mps_data_clean_temp$Date) %m-% months(12)
    ) %>%
  dplyr::select(Date, MPS, Charges) %>%
  dplyr::mutate(Date = format(Date, "%Y-%m")) %>% 
  tidyr::spread(MPS, Charges) %>%
  dplyr::mutate(
    Total = rowSums(dplyr::select(., -Date), na.rm = TRUE)
    ) %>%
  kableExtra::kable (
    format = "markdown", 
    caption = "Breakdown of Charges by MPS", 
    linesep = "",
    format.args = list(big.mark = ",")
    )

```

## On-Time Task Completion

```{r message = FALSE, echo = FALSE, error = FALSE, warning = FALSE}

mps_data_clean_temp %>%
  dplyr::select(
    Trading.Party.ID, Date, MPS, Charges
    ) %>%
  ggplot2::ggplot(
    ggplot2::aes(x = Date, y = Charges, fill = MPS)
    ) + 
  ggplot2::geom_bar(stat = "identity") + 
  ggplot2::theme(
    legend.title = ggplot2::element_blank(),
    text = ggplot2::element_text(size = 20)
    ) +
  ggplot2::scale_y_continuous(
    labels = scales::comma,
    breaks = scales::pretty_breaks(4)
    ) +
  ggplot2::labs(
    title = "Performance Charges",
    subtitle = "Breakdown of by month and standard",
    caption = "Source: MOSL"
    ) +
  ggplot2::ylab("Charges (£)") + ggplot2::xlab("")

```

```{r echo = FALSE, results = "asis"}

mps_data_clean_temp %>% 
  dplyr::filter(
    Date >= max(mps_data_clean_temp$Date) %m-% months(12)
    ) %>%
  dplyr::select(
    Date, MPS, TaskCompletion
    ) %>% 
  dplyr::mutate(
    TaskCompletion = format(TaskCompletion, digits = 2)
    ) %>%
  tidyr::spread(key = MPS, value = TaskCompletion) %>%
  kableExtra::kable(
    format = "markdown", 
    caption = "MPS Performance by Month",
    linesep = "",
    format.args = list(big.mark = ",")
    )

```

## Performance Issues

At the beginning of this period, `r SHORT.NAME` had:

* `r sum(perf_status_mps_temp$ActiveIPRP, na.rm = TRUE)` performance issue(s) on an active IPRP
* `r sum(perf_status_mps_temp$Pending, na.rm = TRUE)` performance issue(s) on an IPRP but MOSL is awaiting further details of the plan(s)
* `r sum(perf_status_mps_temp$UnderReview, na.rm = TRUE)` performance issue(s) being reviewed by MOSL for an IPRP or an extension of an IPRP
* `r sum(perf_status_mps_temp$IPRPend, na.rm = TRUE)` performance issue(s) that reached the end of a plan

Of the performance issue(s) on an active IPRP:

* `r sum(perf_status_mps_temp$MilestoneFlag, na.rm = TRUE)` are underperforming versus the milestones contained in the plan

Of those performance standards not on an IPRP or under a review:

* `r sum(perf_status_mps_temp$PerfFlag3m & !(perf_status_mps_temp$ActiveIPRP | perf_status_mps_temp$Pending | perf_status_mps_temp$UnderReview), na.rm = TRUE)` were flagged for poor performance

In this period, `r SHORT.NAME` has:

``` {r echo = FALSE}

perf_status_mps_temp %>%
  dplyr::select(MPS, Action, ActiveIPRP, PerfFlag3m) %>%
  kableExtra::kable(
    format = "markdown", 
    caption = "Summary of recent flags and actions",
    linesep = ""
  )

```

Where an Action is recorded as “Watch”, the performance issue will be added to MOSL’s watch-list of performance issues. Any performance issue(s) on the watch-list will be closely monitored for improvement each month until it is removed from the list. If the issue is not resolved, then it could be escalated to an IPRP. 
`r paste(SHORT.NAME)` had X performance issues on watch at the beginning of CURRENT-MONTH, covering: MPS 2 and MPS 16. Of these:

See section Z for more information on each MPS, including further commentary (if applicable) on the above performance issues, historical performance and any IPRPs currently active. 

## MPS Analysis

As part of its analysis of historical MPS performance, MOSL categorises performance over a 6-month period according to consistency and by comparing performance to the market mean performance over the same period. For example, mean performance over six-months at, or close to, the mean market level, in most months (i.e. 3 or more of the last 6 months) would be rated as “consistent, good”. 

See Appendix I for further information of how MOSL categorises MPS performance. 

```{r, echo = FALSE, results = "asis"}

res <- lapply(unique(as.character(mps_data_clean_temp$MPS)), function (MPS_CHUNK) {
  
  knitr::knit_child(
    "pfm_report_mps_template.Rmd", envir = environment(), quiet = TRUE
  )
  
})

cat(unlist(res), sep = "\n")

```

## MPS Market Aggregates

### Mean peer performance

```{r echo = FALSE, results = "asis"}

mps_summary %>% 
  dplyr::select(
    Date, MPS, MPS_Mean
    ) %>% 
  dplyr::filter(
    Date >= Sys.Date() %m-% months(12)
    ) %>% 
  tidyr::spread(MPS, MPS_Mean) %>%
  kableExtra::kable(
    format = "markdown", 
    caption = "Mean peer performance", 
    booktabs = TRUE, 
    linesep = "",
    digits = 1,
    format.args = list(decimal.mark = ".", big.mark = ",")
    ) 

```

### Median peer performance

```{r echo = FALSE, results = "asis"}

mps_summary %>% 
  dplyr::select(
    Date, MPS, MPS_Median
    ) %>% 
  dplyr::filter(
    Date >= Sys.Date() %m-% months(12)
    ) %>% 
  tidyr::spread(MPS, MPS_Median) %>%
  kableExtra::kable(
    format = "markdown", 
    caption = "Median peer performance", 
    booktabs = TRUE, 
    linesep = "",
    digits = 1,
    format.args = list(decimal.mark = ".", big.mark = ",")
    ) 

```

### Aggregate task volumes

```{r echo = FALSE, results = "asis"}

mps_summary %>% 
  dplyr::select(
    Date, MPS, TotalTaskVolume
    ) %>% 
  dplyr::filter(
    Date >= Sys.Date() %m-% months(12)
    ) %>% 
  tidyr::spread(MPS, TotalTaskVolume) %>%
  kableExtra::kable(
    format = "markdown", 
    caption = "Total Task Volume", 
    booktabs = TRUE, 
    linesep = "",
    digits = 1,
    format.args = list(decimal.mark = ".", big.mark = ",")
    ) 

```

# Appendix

## Performance Criteria

A Trading Party's MPS performance will be flagged when the ratio of on-time task completion to total tasks completed for that MPS falls below the peer mean and peer median level for three consecutive months. "Peer mean" and "peer median" refer, respectively, to the mean and median of all on-time task ratios for every Trading Party in the market. The following MPS are currently subject to this criteria: MPS 1, MPS 2, MPS 3, MPS 4, MPS 7, MPS 12, MPS 16, MPS 17.

MPS performance will also be flagged when it is lower than the threshold percentage, set by MOSL. This threshold performance can change when MOSL feel appropriate. Currently, only MPS 18 is subject to a threshold (75%).

When evaluating these performance flags, MOSL takes into account other factors, including: performance relative to comparable peers; number of tasks relative to size; and other important Trading Party activities, such as data improvement activity and significant operational changes.

Persistently poor performance could lead to the issue being escalated to MOSL's Performance Resolution process through an Initial Performance Rectification Plan (IPRP). Failure to improve over time at this stage could lead to the issue being further escalated to a Performance Rectification Plan (PRP) overseen by MPC and / or Panel.
